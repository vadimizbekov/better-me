<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Better Me</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* View Sections */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Habit List */
        .habit-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .habit-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .habit-item.completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .habit-name {
            font-weight: 600;
            font-size: 16px;
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        /* Modern Habit Cards */
        .habit-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .habit-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .habit-card.active {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .habit-toggle-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .habit-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border-radius: 12px;
        }

        .habit-info {
            flex: 1;
        }

        .habit-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .habit-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 32px;
            background: var(--border);
            border-radius: 16px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 28px;
        }

        /* Metric Input Slide-in */
        .metric-input-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .metric-input-container.show {
            max-height: 100px;
            margin-top: 16px;
        }

        .metric-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg);
            padding: 12px;
            border-radius: 12px;
        }

        .metric-input-wrapper input {
            flex: 1;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 60px;
        }

        /* Date Selector */
        .date-selector {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
            color: white;
        }

        .date-selector-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .date-selector-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .date-selector input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        /* Month Buttons */
        .btn-month {
            flex: 1;
            padding: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-month:hover {
            border-color: var(--primary);
        }

        .btn-month.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .habit-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            margin-top: 8px;
        }

        .habit-metric {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .habit-metric input {
            flex: 1;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .habit-metric label {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 60px;
        }

        /* Motivation Section */
        .motivation {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(16, 185, 129, 0.2));
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--primary);
        }

        .motivation h3 {
            font-size: 18px;
            margin-bottom: 16px;
            text-align: center;
        }

        .impact-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .impact-item:last-child {
            border-bottom: none;
        }

        .impact-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .impact-value {
            font-weight: 700;
            color: var(--success);
            font-size: 16px;
        }

        /* Progress Bars */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            max-width: 480px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Weekly Calendar */
        .week-calendar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .day-card {
            flex: 1;
            min-width: 60px;
            padding: 12px 8px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
        }

        .day-card.today {
            border-color: var(--primary);
        }

        .day-card.completed {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
        }

        .day-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .day-date {
            font-size: 18px;
            font-weight: 700;
        }

        .day-completion {
            font-size: 10px;
            color: var(--success);
            margin-top: 4px;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            padding: 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Better Me</h1>
                <p id="authSubtitle">Sign up to start tracking your habits</p>
            </div>

            <div id="authError" class="error-message hidden"></div>

            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label class="form-label" for="authEmail">Email</label>
                    <input
                        type="email"
                        id="authEmail"
                        class="form-input"
                        placeholder="your@email.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="authPassword">Password</label>
                    <input
                        type="password"
                        id="authPassword"
                        class="form-input"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        minlength="6"
                        required
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="authButton">
                    Sign Up
                </button>
            </form>

            <div class="auth-toggle">
                <span id="authToggleText">Already have an account?</span>
                <button type="button" onclick="toggleAuthMode()">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="container" id="mainApp" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1>Better Me</h1>
            <p id="currentDate">Loading...</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchView('overview')">Overview</button>
            <button class="tab" onclick="switchView('tracker')">Tracker</button>
            <button class="tab" onclick="switchView('settings')">Settings</button>
        </div>

        <!-- OVERVIEW -->
        <div id="overviewView" class="view active">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCompletion">0%</div>
                    <div class="stat-label">Today's Progress</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="weekStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="weekCompletion">0%</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthCompletion">0%</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <!-- Transformation Progress -->
            <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(16, 185, 129, 0.1)); border: 2px solid var(--primary);">
                <div class="card-header">
                    <h2 class="card-title">üî• Your Transformation</h2>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                        Building the person you want to become
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: var(--primary);" id="disciplineScore">
                        0%
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        Discipline Score (Last 30 Days)
                    </div>
                </div>

                <!-- Transformation Areas -->
                <div style="display: grid; gap: 12px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üí™ Physical</span>
                            <span style="font-weight: 700; color: var(--success);" id="physicalScore">0%</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Running + Fitness</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üß† Mental</span>
                            <span style="font-weight: 700; color: var(--success);" id="mentalScore">0%</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Ice Baths + Meditation + Diary</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üó£Ô∏è Skills</span>
                            <span style="font-weight: 700; color: var(--success);" id="skillsScore">0%</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">English Learning</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üéØ Self-Discipline</span>
                            <span style="font-weight: 700; color: var(--success);" id="disciplineStreak">0 days</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);" id="streakDescription">Streak of consistent days</div>
                    </div>
                </div>

                <!-- Motivational Message -->
                <div id="motivationMessage" style="margin-top: 16px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; text-align: center; font-size: 14px; line-height: 1.6; color: var(--text);">
                    Every day you show up, you're becoming someone new.
                </div>
            </div>

            <!-- This Week (Mon-Sun) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÖ <span id="weekTitle">This Week</span></h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="changeWeek(-1)" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 16px;">‚Üê</button>
                        <span id="weekRange" style="font-size: 12px; color: var(--text-secondary); min-width: 120px; text-align: center;"></span>
                        <button onclick="changeWeek(1)" id="weekNextBtn" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 16px;">‚Üí</button>
                    </div>
                </div>
                <div id="weeklyOverview">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Monthly Tabs -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÜ Monthly Overview</h2>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="btn-month active" onclick="switchMonth(0)">This Month</button>
                    <button class="btn-month" onclick="switchMonth(-1)">Last Month</button>
                    <button class="btn-month" onclick="switchMonth(-2)">2 Months Ago</button>
                </div>
                <div id="monthTitle" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;"></div>
                <div id="monthlyOverview">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- TRACKER VIEW (Combined Log + History) -->
        <div id="trackerView" class="view">
            <!-- Date Selector -->
            <div class="date-selector">
                <div class="date-selector-label">Tracking for</div>
                <div class="date-selector-value" id="reviewDateDisplay">Today</div>
                <input
                    type="date"
                    id="selectedDate"
                    onchange="loadSelectedDate()">
            </div>

            <!-- Modern Habit Cards -->
            <div id="modernHabits">
                <!-- Populated by JS -->
            </div>

            <!-- Mood & Notes Card -->
            <div class="card" style="margin-top: 20px;">
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px;">
                        <label style="font-weight: 600; font-size: 16px; margin-bottom: 8px; display: block;">üòä How was your day? (1-10)</label>
                        <input type="number" min="1" max="10" id="mood" placeholder="7" style="width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; font-size: 16px; margin-bottom: 8px; display: block;">üìù Notes</label>
                        <textarea id="notes" rows="3" placeholder="Any thoughts about today?" style="width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveEntry()" style="margin-top: 20px;">üíæ Save Entry</button>

            <!-- Complete History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìä Your Complete History</h2>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    All your daily habit tracking data - click Edit to modify any day
                </div>
                <div id="detailedHistory" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Weekly Targets</h2>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    Set how many times per week you want to do each habit
                </div>
                <div class="habit-list" id="settingsHabits">
                    <!-- Populated by JS -->
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>

        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCbdjv2kmYl9em_E1Xd3G_m3TPJ-308o68",
            authDomain: "better-me-8e533.firebaseapp.com",
            projectId: "better-me-8e533",
            storageBucket: "better-me-8e533.firebasestorage.app",
            messagingSenderId: "200319965841",
            appId: "1:200319965841:web:37bbc5588fdd8e8b16bd30",
            databaseURL: "https://better-me-8e533-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Set persistence to LOCAL (stays logged in even after closing browser)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // Global variables
        let currentUser = null;
        let isSignUpMode = true;

        // Data structure with default targets and start dates
        let habits = [
            { id: 'running', name: 'Running', emoji: 'üèÉ', hasMetric: true, metricLabel: 'km', target: 4, startDate: null },
            { id: 'icebaths', name: 'Ice Baths', emoji: 'üßä', hasMetric: false, target: 7, startDate: null },
            { id: 'meditation', name: 'Meditation', emoji: 'üßò', hasMetric: true, metricLabel: 'min', target: 7, startDate: null },
            { id: 'diary', name: 'Diary', emoji: 'üìî', hasMetric: false, target: 7, startDate: null },
            { id: 'english', name: 'English', emoji: 'üó£Ô∏è', hasMetric: false, target: 3, startDate: null },
            { id: 'fitness', name: 'Fitness', emoji: 'üí™', hasMetric: true, metricLabel: 'min', target: 3, startDate: null }
        ];

        let data = {};
        let settings = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';

                    // Load user data
                    await loadDataFromFirebase();
                    await loadSettingsFromFirebase();
                    loadSettingsIntoHabits();
                    updateCurrentDate();
                    loadOverviewView();
                    updateStats();
                    updateMotivation();
                    renderWeekCalendar();
                } else {
                    // User is signed out
                    currentUser = null;
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });
        });

        // Auth Functions
        async function handleAuth(event) {
            event.preventDefault();

            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');

            errorEl.classList.add('hidden');

            try {
                if (isSignUpMode) {
                    // Sign up new user
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    // Sign in existing user
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.remove('hidden');
            }
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;

            const subtitle = document.getElementById('authSubtitle');
            const button = document.getElementById('authButton');
            const toggleText = document.getElementById('authToggleText');
            const toggleButton = document.querySelector('.auth-toggle button');

            if (isSignUpMode) {
                subtitle.textContent = 'Sign up to start tracking your habits';
                button.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleButton.textContent = 'Sign In';
            } else {
                subtitle.textContent = 'Welcome back! Sign in to continue';
                button.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleButton.textContent = 'Sign Up';
            }

            // Clear error
            document.getElementById('authError').classList.add('hidden');
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/email-already-in-use':
                    return 'This email is already registered. Please sign in instead.';
                case 'auth/invalid-email':
                    return 'Invalid email address.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }

        // Firebase Data Functions
        async function loadDataFromFirebase() {
            if (!currentUser) return;
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}/habitData`).once('value');
                data = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading data:', error);
                data = {};
            }
        }

        async function saveData() {
            if (!currentUser) return;
            try {
                await database.ref(`users/${currentUser.uid}/habitData`).set(data);
            } catch (error) {
                console.error('Error saving data:', error);
                alert('‚ö†Ô∏è Error saving data. Please try again.');
            }
        }

        async function loadSettingsFromFirebase() {
            if (!currentUser) return;
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}/settings`).once('value');
                settings = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading settings:', error);
                settings = {};
            }
        }

        async function saveSettingsData() {
            if (!currentUser) return;
            try {
                await database.ref(`users/${currentUser.uid}/settings`).set(settings);
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('‚ö†Ô∏è Error saving settings. Please try again.');
            }
        }

        function loadSettingsIntoHabits() {
            // Update habit targets and start dates from saved settings
            habits.forEach(habit => {
                if (settings[habit.id] !== undefined) {
                    habit.target = settings[habit.id];
                }
                if (settings[habit.id + '_startDate'] !== undefined) {
                    habit.startDate = settings[habit.id + '_startDate'];
                }
            });
        }

        function updateCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
        }

        function getTodayKey() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function switchView(view) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');

            // Refresh data
            if (view === 'overview') loadOverviewView();
            if (view === 'tracker') {
                selectedDateKey = null; // Reset to today when switching to tracker view
                loadTrackerView();
            }
            if (view === 'settings') loadSettingsView();
        }

        function loadOverviewView() {
            updateStats();
            updateMotivation();
            renderWeeklyOverview(selectedWeekOffset);
            renderMonthlyOverview(selectedMonthOffset);
        }

        function changeWeek(direction) {
            selectedWeekOffset += direction;
            renderWeeklyOverview(selectedWeekOffset);

            // Update next button state (disable if viewing current week)
            const nextBtn = document.getElementById('weekNextBtn');
            if (selectedWeekOffset >= 0) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.3';
                nextBtn.style.cursor = 'not-allowed';
                selectedWeekOffset = 0; // Can't go beyond current week
            } else {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }

        let selectedDateKey = null;
        let selectedMonthOffset = 0; // 0 = this month, -1 = last month, etc.
        let selectedWeekOffset = 0; // 0 = this week, -1 = last week, etc.

        function loadTrackerView() {
            renderModernHabits();
            loadLogView();
            renderDetailedHistory();
        }

        function renderModernHabits() {
            const container = document.getElementById('modernHabits');
            container.innerHTML = '';

            const dateKey = selectedDateKey || getTodayKey();
            const dateData = data[dateKey] || {};

            habits.forEach(habit => {
                const habitData = dateData[habit.id] || {};
                const isDone = habitData.done || false;
                const value = habitData.value || '';

                const card = document.createElement('div');
                card.className = 'habit-card' + (isDone ? ' active' : '');
                card.id = 'modern-habit-' + habit.id;

                const metricInput = habit.hasMetric ? `
                    <div class="metric-input-container ${isDone ? 'show' : ''}" id="metric-${habit.id}">
                        <div class="metric-input-wrapper">
                            <span class="metric-label">${habit.metricLabel === 'km' ? 'Distance' : 'Duration'}</span>
                            <input
                                type="number"
                                step="${habit.metricLabel === 'km' ? '0.1' : '1'}"
                                id="${habit.id}-${habit.metricLabel}"
                                placeholder="0${habit.metricLabel === 'km' ? '.0' : ''}"
                                value="${value}"
                                onclick="event.stopPropagation()">
                            <span class="metric-label">${habit.metricLabel}</span>
                        </div>
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="habit-toggle-header" onclick="toggleModernHabit('${habit.id}')">
                        <div class="habit-icon">${habit.emoji}</div>
                        <div class="habit-info">
                            <div class="habit-title">${habit.name}</div>
                            <div class="habit-subtitle">${isDone ? (value ? `${value} ${habit.metricLabel}` : 'Completed ‚úì') : 'Tap to mark as done'}</div>
                        </div>
                        <div class="toggle-switch ${isDone ? 'active' : ''}" id="toggle-${habit.id}">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    ${metricInput}
                `;

                container.appendChild(card);
            });
        }

        function toggleModernHabit(habitId) {
            const card = document.getElementById('modern-habit-' + habitId);
            const toggle = document.getElementById('toggle-' + habitId);
            const metricContainer = document.getElementById('metric-' + habitId);

            const isActive = toggle.classList.contains('active');

            if (isActive) {
                card.classList.remove('active');
                toggle.classList.remove('active');
                if (metricContainer) {
                    metricContainer.classList.remove('show');
                }
            } else {
                card.classList.add('active');
                toggle.classList.add('active');
                if (metricContainer) {
                    metricContainer.classList.add('show');
                    // Focus on input
                    const input = metricContainer.querySelector('input');
                    if (input) {
                        setTimeout(() => input.focus(), 300);
                    }
                }
            }

            updateSubtitle(habitId);
        }

        function updateSubtitle(habitId) {
            const habit = habits.find(h => h.id === habitId);
            const card = document.getElementById('modern-habit-' + habitId);
            const toggle = document.getElementById('toggle-' + habitId);
            const isActive = toggle.classList.contains('active');

            const subtitle = card.querySelector('.habit-subtitle');

            if (isActive) {
                if (habit.hasMetric) {
                    const input = document.getElementById(habit.id + '-' + habit.metricLabel);
                    const value = input ? input.value : '';
                    subtitle.textContent = value ? `${value} ${habit.metricLabel}` : 'Completed ‚úì';

                    // Update subtitle when input changes
                    if (input) {
                        input.oninput = () => {
                            subtitle.textContent = input.value ? `${input.value} ${habit.metricLabel}` : 'Completed ‚úì';
                        };
                    }
                } else {
                    subtitle.textContent = 'Completed ‚úì';
                }
            } else {
                subtitle.textContent = 'Tap to mark as done';
            }
        }

        function loadLogView() {
            const dateKey = selectedDateKey || getTodayKey();
            const dateData = data[dateKey] || {};

            // Update date picker
            document.getElementById('selectedDate').value = dateKey;

            // Update review date display
            const date = new Date(dateKey);
            const isToday = dateKey === getTodayKey();
            const displayDate = isToday ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('reviewDateDisplay').textContent = displayDate;

            // Render modern habits
            renderModernHabits();

            // Load mood and notes
            document.getElementById('mood').value = dateData.mood || '';
            document.getElementById('notes').value = dateData.notes || '';
        }

        function loadSelectedDate() {
            selectedDateKey = document.getElementById('selectedDate').value;
            loadLogView();
        }

        async function saveEntry() {
            const dateKey = selectedDateKey || getTodayKey();

            if (!data[dateKey]) {
                data[dateKey] = {};
            }

            // Save habits from modern cards
            habits.forEach(habit => {
                const toggle = document.getElementById('toggle-' + habit.id);
                const done = toggle ? toggle.classList.contains('active') : false;

                data[dateKey][habit.id] = { done };

                // Save metrics
                if (habit.hasMetric) {
                    const input = document.getElementById(habit.id + '-' + habit.metricLabel);
                    if (input && input.value) {
                        data[dateKey][habit.id].value = parseFloat(input.value);
                    }
                }
            });

            // Save mood and notes
            const mood = document.getElementById('mood').value;
            const notes = document.getElementById('notes').value;

            if (mood) data[dateKey].mood = parseInt(mood);
            if (notes) data[dateKey].notes = notes;

            await saveData();

            // Show success feedback
            const isToday = dateKey === getTodayKey();
            alert(isToday ? '‚úÖ Entry saved to cloud successfully!' : '‚úÖ Past entry updated successfully!');

            // Refresh views
            loadOverviewView();
            updateStats();
            updateMotivation();
            renderWeekCalendar();
            renderDetailedHistory();
        }

        function updateStats() {
            const todayKey = getTodayKey();
            const todayData = data[todayKey] || {};

            // Today's completion (only count habits that have started)
            let todayCompleted = 0;
            let todayActiveHabits = 0;
            habits.forEach(habit => {
                if (!habit.startDate || todayKey >= habit.startDate) {
                    todayActiveHabits++;
                    if (todayData[habit.id]?.done) todayCompleted++;
                }
            });
            const todayPercent = todayActiveHabits > 0 ? Math.round((todayCompleted / todayActiveHabits) * 100) : 0;
            document.getElementById('todayCompletion').textContent = todayPercent + '%';

            // Week completion (Monday-Sunday, respecting start dates)
            const weekData = getCurrentWeekData();
            let weekExpected = 0;
            let weekCompleted = 0;

            habits.forEach(habit => {
                let habitWeekExpected = 0;
                weekData.forEach(day => {
                    if (!habit.startDate || day.date >= habit.startDate) {
                        habitWeekExpected++;
                        if (day.data[habit.id]?.done) weekCompleted++;
                    }
                });
                // Scale target to actual active days in this week
                const daysActive = habitWeekExpected;
                weekExpected += Math.round((habit.target / 7) * daysActive);
            });

            const weekPercent = weekExpected > 0 ? Math.round((weekCompleted / weekExpected) * 100) : 0;
            document.getElementById('weekCompletion').textContent = weekPercent + '%';

            // Streak
            const streak = calculateStreak();
            document.getElementById('weekStreak').textContent = streak;

            // Month completion (calendar month, respecting start dates)
            const monthInfo = getMonthData(0); // Current month
            const monthData = monthInfo.data;
            let monthExpected = 0;
            let monthCompleted = 0;

            habits.forEach(habit => {
                let habitMonthExpected = 0;
                monthData.forEach(day => {
                    if (!habit.startDate || day.date >= habit.startDate) {
                        habitMonthExpected++;
                        if (day.data[habit.id]?.done) monthCompleted++;
                    }
                });
                // Scale target to actual active days in this month
                monthExpected += Math.round((habit.target / 7) * habitMonthExpected);
            });

            const monthPercent = monthExpected > 0 ? Math.round((monthCompleted / monthExpected) * 100) : 0;
            document.getElementById('monthCompletion').textContent = monthPercent + '%';
        }

        function getCurrentWeekData() {
            // Get current week Monday-Sunday
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days

            const result = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysFromMonday + i);
                const key = date.toISOString().split('T')[0];
                result.push({ date: key, data: data[key] || {} });
            }
            return result;
        }

        function getPreviousWeekData() {
            // Get last week Monday-Sunday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            const result = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysFromMonday - 7 + i); // Go back one week
                const key = date.toISOString().split('T')[0];
                result.push({ date: key, data: data[key] || {} });
            }
            return result;
        }

        function getMonthData(monthOffset = 0) {
            // Get calendar month data (monthOffset: 0 = current, -1 = last month, etc.)
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + monthOffset;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const result = [];
            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                const key = d.toISOString().split('T')[0];
                result.push({ date: key, data: data[key] || {} });
            }

            return {
                data: result,
                monthName: firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                daysInMonth: result.length
            };
        }

        function updateMotivation() {
            // Use last 30 days rolling (never resets)
            const last30Days = getLastNDays(30);

            // Helper function to count days a habit was active in the period
            function getActiveDays(habit) {
                if (!habit.startDate) return last30Days.length; // No start date = active for all days

                let activeDays = 0;
                last30Days.forEach(day => {
                    if (day.date >= habit.startDate) activeDays++;
                });
                return activeDays;
            }

            // Calculate habit completion for last 30 days (respecting start dates)
            let running = 0, icebaths = 0, meditation = 0, diary = 0, english = 0, fitness = 0;
            let totalCompleted = 0, totalExpected = 0;

            const runningHabit = habits.find(h => h.id === 'running');
            const icebathHabit = habits.find(h => h.id === 'icebaths');
            const meditationHabit = habits.find(h => h.id === 'meditation');
            const diaryHabit = habits.find(h => h.id === 'diary');
            const englishHabit = habits.find(h => h.id === 'english');
            const fitnessHabit = habits.find(h => h.id === 'fitness');

            last30Days.forEach(day => {
                if (day.date >= (runningHabit.startDate || '2000-01-01') && day.data.running?.done) running++;
                if (day.date >= (icebathHabit.startDate || '2000-01-01') && day.data.icebaths?.done) icebaths++;
                if (day.date >= (meditationHabit.startDate || '2000-01-01') && day.data.meditation?.done) meditation++;
                if (day.date >= (diaryHabit.startDate || '2000-01-01') && day.data.diary?.done) diary++;
                if (day.date >= (englishHabit.startDate || '2000-01-01') && day.data.english?.done) english++;
                if (day.date >= (fitnessHabit.startDate || '2000-01-01') && day.data.fitness?.done) fitness++;
            });

            // Expected based on active days only
            const runningActiveDays = getActiveDays(runningHabit);
            const icebathActiveDays = getActiveDays(icebathHabit);
            const meditationActiveDays = getActiveDays(meditationHabit);
            const diaryActiveDays = getActiveDays(diaryHabit);
            const englishActiveDays = getActiveDays(englishHabit);
            const fitnessActiveDays = getActiveDays(fitnessHabit);

            const runningExpected = Math.round((runningHabit.target / 7) * runningActiveDays);
            const icebathExpected = Math.round((icebathHabit.target / 7) * icebathActiveDays);
            const meditationExpected = Math.round((meditationHabit.target / 7) * meditationActiveDays);
            const diaryExpected = Math.round((diaryHabit.target / 7) * diaryActiveDays);
            const englishExpected = Math.round((englishHabit.target / 7) * englishActiveDays);
            const fitnessExpected = Math.round((fitnessHabit.target / 7) * fitnessActiveDays);

            totalExpected = runningExpected + icebathExpected + meditationExpected + diaryExpected + englishExpected + fitnessExpected;
            totalCompleted = running + icebaths + meditation + diary + english + fitness;

            // Overall Discipline Score (last 30 days, respecting start dates)
            const disciplineScore = totalExpected > 0 ? Math.round((totalCompleted / totalExpected) * 100) : 0;
            document.getElementById('disciplineScore').textContent = disciplineScore + '%';

            // Physical: Running + Fitness (respecting start dates)
            const physicalExpected = runningExpected + fitnessExpected;
            const physicalCompleted = running + fitness;
            const physicalScore = physicalExpected > 0 ? Math.round((physicalCompleted / physicalExpected) * 100) : 0;
            document.getElementById('physicalScore').textContent = physicalScore + '%';

            // Mental: Ice Baths + Meditation + Diary (respecting start dates)
            const mentalExpected = icebathExpected + meditationExpected + diaryExpected;
            const mentalCompleted = icebaths + meditation + diary;
            const mentalScore = mentalExpected > 0 ? Math.round((mentalCompleted / mentalExpected) * 100) : 0;
            document.getElementById('mentalScore').textContent = mentalScore + '%';

            // Skills: English (respecting start date)
            const skillsScore = englishExpected > 0 ? Math.round((english / englishExpected) * 100) : 0;
            document.getElementById('skillsScore').textContent = skillsScore + '%';

            // Self-Discipline Streak (counts weeks, not days)
            const streak = calculateStreak();
            document.getElementById('disciplineStreak').textContent = streak + ' week' + (streak !== 1 ? 's' : '');

            // Update streak description
            const totalWeeklyTarget = habits.reduce((sum, h) => sum + h.target, 0);
            document.getElementById('streakDescription').textContent = `Weeks with 80%+ completion (${Math.round(totalWeeklyTarget * 0.8)}/${totalWeeklyTarget} habits)`;

            // Dynamic Motivational Message
            const messages = {
                excellent: [
                    "You're not just doing habits. You're proving to yourself who you really are.",
                    "Discipline is building your future self. Every day, you're becoming stronger.",
                    "This consistency isn't luck - it's you choosing transformation every single day.",
                    "You're building an identity of someone who keeps their word to themselves."
                ],
                good: [
                    "You're showing up. That's what separates dreamers from achievers.",
                    "Each habit completed is a vote for the person you're becoming.",
                    "The discipline you're building now will compound into everything you do.",
                    "You're not perfect, but you're consistent. That's what matters most."
                ],
                moderate: [
                    "Transformation isn't linear. Every day you try is a day you're growing.",
                    "The gap between who you are and who you want to be closes with each habit.",
                    "You started this journey for a reason. That reason is still valid.",
                    "Self-discipline isn't built in perfect weeks - it's built by showing up after setbacks."
                ],
                low: [
                    "This week is just one chapter. Your transformation story is far from over.",
                    "The person you want to become is built in weeks like this - when you choose to continue.",
                    "You're learning what it takes. This data is valuable. Use it to adapt.",
                    "Discipline isn't about never falling - it's about always getting back up."
                ]
            };

            let messageCategory;
            if (disciplineScore >= 80) messageCategory = 'excellent';
            else if (disciplineScore >= 60) messageCategory = 'good';
            else if (disciplineScore >= 40) messageCategory = 'moderate';
            else messageCategory = 'low';

            const randomMessage = messages[messageCategory][Math.floor(Math.random() * messages[messageCategory].length)];
            document.getElementById('motivationMessage').textContent = randomMessage;
        }

        function getWeekData(weeksAgo) {
            // Get data for a specific week (0 = current week, -1 = last week)
            const result = [];
            const startOffset = weeksAgo * 7;
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - startOffset - i);
                const key = date.toISOString().split('T')[0];
                result.push({
                    date: key,
                    data: data[key] || {}
                });
            }
            return result.reverse();
        }

        function calculateWeekCompletion(weekData) {
            let totalExpected = 0;
            let totalCompleted = 0;

            habits.forEach(habit => {
                totalExpected += habit.target;
                weekData.forEach(day => {
                    if (day.data[habit.id]?.done) totalCompleted++;
                });
            });

            return totalExpected > 0 ? Math.round((totalCompleted / totalExpected) * 100) : 0;
        }

        function getLastNDays(n) {
            const result = [];
            for (let i = 0; i < n; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                result.push({
                    date: key,
                    data: data[key] || {}
                });
            }
            return result.reverse();
        }

        function calculateStreak() {
            let streak = 0;

            const today = new Date();
            const dayOfWeek = today.getDay();

            // Start from last week if current week is incomplete (not Sunday)
            // Only count complete weeks for the streak
            const startWeek = (dayOfWeek === 0) ? 0 : 1; // If Sunday, include current week; otherwise start from last week

            // Check weeks going backward from most recent complete week
            for (let weeksAgo = startWeek; weeksAgo < 52; weeksAgo++) {
                const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

                // Get the Monday of the week we're checking
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - daysFromMonday - (weeksAgo * 7));

                // Calculate expected target for THIS WEEK based on active habits
                let weekExpected = 0;
                let weekCompleted = 0;

                habits.forEach(habit => {
                    let habitWeekExpected = 0;

                    // Count days this week where the habit was active
                    for (let i = 0; i < 7; i++) {
                        const checkDate = new Date(weekStart);
                        checkDate.setDate(weekStart.getDate() + i);
                        const key = checkDate.toISOString().split('T')[0];
                        const dayData = data[key];

                        // Only count if habit had started by this day
                        if (!habit.startDate || key >= habit.startDate) {
                            habitWeekExpected++;
                            if (dayData && dayData[habit.id]?.done) {
                                weekCompleted++;
                            }
                        }
                    }

                    // Add this habit's expected completions for the week
                    // Scale target to actual active days
                    weekExpected += Math.round((habit.target / 7) * habitWeekExpected);
                });

                // Week counts if you hit 80%+ of your weekly targets (respecting start dates)
                const weekPercentage = weekExpected > 0 ? (weekCompleted / weekExpected) : 0;
                if (weekPercentage >= 0.8) {
                    streak++;
                } else {
                    break; // Streak ends
                }
            }

            return streak;
        }

        function renderWeekCalendar() {
            const container = document.getElementById('weekCalendar');
            container.innerHTML = '';

            const weekData = getLastNDays(7);
            const todayKey = getTodayKey();

            weekData.forEach(day => {
                let completed = 0;
                habits.forEach(habit => {
                    if (day.data[habit.id]?.done) completed++;
                });

                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();

                const isToday = day.date === todayKey;
                const completionPercent = Math.round((completed / habits.length) * 100);

                const dayCard = document.createElement('div');
                dayCard.className = 'day-card' + (isToday ? ' today' : '') + (completionPercent === 100 ? ' completed' : '');
                dayCard.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-date">${dayNum}</div>
                    <div class="day-completion">${completionPercent}%</div>
                `;
                dayCard.onclick = () => {
                    selectedDateKey = day.date;
                    loadLogView();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                container.appendChild(dayCard);
            });
        }

        function renderWeeklyOverview(weekOffset = 0) {
            const container = document.getElementById('weeklyOverview');
            container.innerHTML = '';

            // Get week data based on offset
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            const weekData = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysFromMonday + i + (weekOffset * 7));
                const key = date.toISOString().split('T')[0];
                weekData.push({ date: key, data: data[key] || {} });
            }

            // Update week title
            const weekTitle = weekOffset === 0 ? 'This Week' :
                             weekOffset === -1 ? 'Last Week' :
                             `${Math.abs(weekOffset)} Weeks Ago`;
            document.getElementById('weekTitle').textContent = weekTitle;

            // Update week range display
            const firstDay = new Date(weekData[0].date);
            const lastDay = new Date(weekData[6].date);
            const rangeText = `${firstDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${lastDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            document.getElementById('weekRange').textContent = rangeText;

            habits.forEach(habit => {
                let completed = 0;

                weekData.forEach(day => {
                    if (day.data[habit.id]?.done) completed++;
                });

                const target = habit.target;
                const percent = Math.min(Math.round((completed / target) * 100), 100);
                const displayCompleted = Math.min(completed, target);

                const habitEl = document.createElement('div');
                habitEl.style.marginBottom = '16px';
                habitEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${habit.emoji} ${habit.name}</span>
                        <span style="font-weight: 700;">${displayCompleted}/${target} (${percent}%)${completed > target ? ' üî•' : ''}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(habitEl);
            });
        }

        function switchMonth(offset) {
            selectedMonthOffset = offset;

            // Update button active states
            const buttons = document.querySelectorAll('.btn-month');
            buttons.forEach((btn, idx) => {
                if (idx === Math.abs(offset)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render monthly overview
            renderMonthlyOverview(offset);
        }

        function renderMonthlyOverview(monthOffset = 0) {
            const container = document.getElementById('monthlyOverview');
            container.innerHTML = '';

            const monthInfo = getMonthData(monthOffset);
            const monthData = monthInfo.data;

            // Update month title
            document.getElementById('monthTitle').textContent = `${monthInfo.monthName} (${monthInfo.daysInMonth} days)`;

            habits.forEach(habit => {
                let completed = 0;
                let totalMetric = 0;

                monthData.forEach(day => {
                    if (day.data[habit.id]?.done) {
                        completed++;
                        if (habit.hasMetric && day.data[habit.id]?.value) {
                            totalMetric += day.data[habit.id].value;
                        }
                    }
                });

                // Calculate monthly target: weekly target * number of full weeks in this month
                const weeksInMonth = Math.floor(monthInfo.daysInMonth / 7);
                const monthlyTarget = habit.target * weeksInMonth;
                const percent = monthlyTarget > 0 ? Math.min(Math.round((completed / monthlyTarget) * 100), 100) : 0;
                const displayCompleted = Math.min(completed, monthlyTarget);

                const habitEl = document.createElement('div');
                habitEl.style.marginBottom = '16px';
                habitEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${habit.emoji} ${habit.name}</span>
                        <span style="font-weight: 700;">${displayCompleted}/${monthlyTarget} (${percent}%)${completed > monthlyTarget ? ' üî•' : ''}</span>
                    </div>
                    ${habit.hasMetric && totalMetric > 0 ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Total: ${totalMetric.toFixed(1)} ${habit.metricLabel}</div>` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(habitEl);
            });
        }

        function renderDetailedHistory() {
            const container = document.getElementById('detailedHistory');
            container.innerHTML = '';

            // Get all dates that have data, sorted newest first
            const allDates = Object.keys(data).sort().reverse();

            if (allDates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No data yet. Start tracking your habits!</div>';
                return;
            }

            // Create a table-like view
            allDates.forEach(date => {
                const dayData = data[date];
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

                let completedCount = 0;
                habits.forEach(habit => {
                    if (dayData[habit.id]?.done) completedCount++;
                });

                const dayCard = document.createElement('div');
                dayCard.style.background = 'var(--bg)';
                dayCard.style.padding = '16px';
                dayCard.style.borderRadius = '12px';
                dayCard.style.marginBottom = '12px';
                dayCard.style.border = '1px solid var(--border)';

                let habitsHTML = '';
                habits.forEach(habit => {
                    const habitData = dayData[habit.id];
                    const isDone = habitData?.done || false;
                    const value = habitData?.value;

                    const icon = isDone ? '‚úÖ' : '‚ùå';
                    const valueText = value ? ` (${value} ${habit.metricLabel})` : '';

                    habitsHTML += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                            <span style="font-size: 16px;">${icon}</span>
                            <span style="flex: 1; ${isDone ? 'color: var(--text);' : 'color: var(--text-secondary); opacity: 0.6;'}">${habit.emoji} ${habit.name}${valueText}</span>
                        </div>
                    `;
                });

                dayCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 700; font-size: 16px;">${formattedDate}</div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 14px; color: var(--text-secondary);">${completedCount}/${habits.length} completed</div>
                            <button onclick="editDay('${date}')" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Edit</button>
                        </div>
                    </div>
                    ${habitsHTML}
                    ${dayData.mood ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 14px; color: var(--text-secondary);">Mood: ${dayData.mood}/10</div>` : ''}
                    ${dayData.notes ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 14px; color: var(--text-secondary); font-style: italic;">"${dayData.notes}"</div>` : ''}
                `;

                container.appendChild(dayCard);
            });
        }

        function editDay(date) {
            // Scroll to top of tracker view
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Load the selected date in the form
            selectedDateKey = date;
            loadLogView();
        }

        function loadSettingsView() {
            const container = document.getElementById('settingsHabits');
            container.innerHTML = '';

            habits.forEach(habit => {
                const habitEl = document.createElement('div');
                habitEl.className = 'habit-item';
                habitEl.innerHTML = `
                    <div class="habit-header">
                        <span class="habit-name">${habit.emoji} ${habit.name}</span>
                    </div>
                    <div class="habit-metric">
                        <label>Times per week</label>
                        <input type="number" min="1" max="7" id="target-${habit.id}" value="${habit.target}">
                    </div>
                    <div class="habit-metric" style="margin-top: 12px;">
                        <label>Start date</label>
                        <input type="date" id="startDate-${habit.id}" value="${habit.startDate || ''}" style="flex: 1;">
                    </div>
                `;
                container.appendChild(habitEl);
            });
        }

        async function saveSettings() {
            habits.forEach(habit => {
                const targetInput = document.getElementById('target-' + habit.id);
                if (targetInput && targetInput.value) {
                    const newTarget = parseInt(targetInput.value);
                    if (newTarget >= 1 && newTarget <= 7) {
                        habit.target = newTarget;
                        settings[habit.id] = newTarget;
                    }
                }

                const startDateInput = document.getElementById('startDate-' + habit.id);
                if (startDateInput && startDateInput.value) {
                    habit.startDate = startDateInput.value;
                    settings[habit.id + '_startDate'] = startDateInput.value;
                }
            });

            await saveSettingsData();
            alert('‚úÖ Settings saved to cloud successfully!');

            // Refresh all views with new targets and start dates
            updateStats();
            updateMotivation();
            renderWeeklyOverview();
            renderMonthlyOverview();
        }

    </script>
</body>
</html>
