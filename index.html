<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Better Me</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* View Sections */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Habit List */
        .habit-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .habit-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .habit-item.completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .habit-name {
            font-weight: 600;
            font-size: 16px;
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        /* Modern Habit Cards */
        .habit-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .habit-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .habit-card.active {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .habit-toggle-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .habit-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border-radius: 12px;
        }

        .habit-info {
            flex: 1;
        }

        .habit-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .habit-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 32px;
            background: var(--border);
            border-radius: 16px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 28px;
        }

        /* Metric Input Slide-in */
        .metric-input-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .metric-input-container.show {
            max-height: 100px;
            margin-top: 16px;
        }

        .metric-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg);
            padding: 12px;
            border-radius: 12px;
        }

        .metric-input-wrapper input {
            flex: 1;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 60px;
        }

        /* Date Selector */
        .date-selector {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
            color: white;
        }

        .date-selector-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .date-selector-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .date-selector input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        /* Month Buttons */
        .btn-month {
            flex: 1;
            padding: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-month:hover {
            border-color: var(--primary);
        }

        .btn-month.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .habit-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            margin-top: 8px;
        }

        .habit-metric {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .habit-metric input {
            flex: 1;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .habit-metric label {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 60px;
        }

        /* Motivation Section */
        .motivation {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(16, 185, 129, 0.2));
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--primary);
        }

        .motivation h3 {
            font-size: 18px;
            margin-bottom: 16px;
            text-align: center;
        }

        .impact-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .impact-item:last-child {
            border-bottom: none;
        }

        .impact-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .impact-value {
            font-weight: 700;
            color: var(--success);
            font-size: 16px;
        }

        /* Progress Bars */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            max-width: 480px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Weekly Calendar */
        .week-calendar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .day-card {
            flex: 1;
            min-width: 60px;
            padding: 12px 8px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
        }

        .day-card.today {
            border-color: var(--primary);
        }

        .day-card.completed {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
        }

        .day-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .day-date {
            font-size: 18px;
            font-weight: 700;
        }

        .day-completion {
            font-size: 10px;
            color: var(--success);
            margin-top: 4px;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            padding: 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* AI Chat Styles */
        .ai-chat-button {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #10b981);
            border: none;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ai-chat-button:active {
            transform: scale(0.95);
        }

        .ai-chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            animation: fadeIn 0.2s ease;
            overflow: hidden;
            touch-action: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ai-chat-modal.show {
            display: flex;
        }

        .ai-chat-container {
            background: var(--bg-card);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 100%;
            height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
            overflow: hidden;
            touch-action: pan-y;
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        @media (min-width: 768px) {
            .ai-chat-modal {
                align-items: center;
                padding: 20px;
            }

            .ai-chat-container {
                border-radius: 16px;
                max-width: 600px;
                height: auto;
                max-height: 80vh;
            }
        }

        .ai-chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .ai-chat-close:hover {
            background: var(--bg);
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-y;
            position: relative;
        }

        .ai-message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .ai-message.assistant .ai-message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--success));
        }

        .ai-message.user .ai-message-avatar {
            background: var(--bg);
        }

        .ai-message-content {
            flex: 1;
            background: var(--bg);
            padding: 12px 14px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .ai-message.user .ai-message-content {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        @media (min-width: 768px) {
            .ai-message-content {
                max-width: 75%;
            }
        }

        .ai-chat-input-container {
            padding: 12px 16px 16px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: var(--bg-card);
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            font-size: 15px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .ai-chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .ai-chat-send {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--primary), var(--success));
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            height: 44px;
        }

        .ai-chat-send:active {
            transform: scale(0.95);
        }

        .ai-chat-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-typing {
            display: flex;
            gap: 4px;
            padding: 8px;
        }

        .ai-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingAnimation 1.4s infinite;
        }

        .ai-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Better Me</h1>
                <p id="authSubtitle">Sign up to start tracking your habits</p>
            </div>

            <div id="authError" class="error-message hidden"></div>

            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label class="form-label" for="authEmail">Email</label>
                    <input
                        type="email"
                        id="authEmail"
                        class="form-input"
                        placeholder="your@email.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="authPassword">Password</label>
                    <input
                        type="password"
                        id="authPassword"
                        class="form-input"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        minlength="6"
                        required
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="authButton">
                    Sign Up
                </button>
            </form>

            <div class="auth-toggle">
                <span id="authToggleText">Already have an account?</span>
                <button type="button" onclick="toggleAuthMode()">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="container" id="mainApp" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1>Better Me</h1>
            <p id="currentDate">Loading...</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchView('overview')">Overview</button>
            <button class="tab" onclick="switchView('tracker')">Tracker</button>
            <button class="tab" onclick="switchView('settings')">Settings</button>
        </div>

        <!-- OVERVIEW -->
        <div id="overviewView" class="view active">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCompletion">0%</div>
                    <div class="stat-label">Today's Progress</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="weekStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="weekCompletion">0%</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthCompletion">0%</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <!-- Transformation Progress -->
            <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(16, 185, 129, 0.1)); border: 2px solid var(--primary);">
                <div class="card-header">
                    <h2 class="card-title">üî• Your Transformation</h2>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                        Building the person you want to become
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: var(--primary);" id="disciplineScore">
                        0%
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        Discipline Score (Last 30 Days)
                    </div>
                </div>

                <!-- Transformation Areas -->
                <div style="display: grid; gap: 12px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üí™ Physical</span>
                            <span style="font-weight: 700; color: var(--success);" id="physicalScore">0%</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Running + Fitness</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üß† Mental</span>
                            <span style="font-weight: 700; color: var(--success);" id="mentalScore">0%</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Ice Baths + Meditation + Diary</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üó£Ô∏è Skills</span>
                            <span style="font-weight: 700; color: var(--success);" id="skillsScore">0%</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">English Learning</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">üéØ Self-Discipline</span>
                            <span style="font-weight: 700; color: var(--success);" id="disciplineStreak">0 days</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);" id="streakDescription">Streak of consistent days</div>
                    </div>
                </div>

                <!-- Motivational Message -->
                <div id="motivationMessage" style="margin-top: 16px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; text-align: center; font-size: 14px; line-height: 1.6; color: var(--text);">
                    Every day you show up, you're becoming someone new.
                </div>

                <!-- Show Impact Button -->
                <button onclick="toggleImpactInsights()" style="width: 100%; margin-top: 16px; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--success)); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span id="impactButtonText">‚ú® Show My Impact</span>
                </button>

                <!-- Impact Insights (Hidden by default) -->
                <div id="impactInsights" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; margin-top: 16px;">
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--primary);">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; text-align: center;">üî¨ Your Transformation Data</h3>

                        <!-- Physical Improvements -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--success);">üí™ Physical Impact</div>
                            <div id="physicalImpact" style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);"></div>
                        </div>

                        <!-- Mental Improvements -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--primary);">üß† Mental Impact</div>
                            <div id="mentalImpact" style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);"></div>
                        </div>

                        <!-- Future Projections -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--warning);">üöÄ Future You (6 months)</div>
                            <div id="futureProjection" style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);"></div>
                        </div>

                        <!-- Totals -->
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; text-align: center;">üìä Your Numbers</div>
                            <div id="totalStats" style="font-size: 12px; line-height: 2; color: var(--text);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- This Week (Mon-Sun) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÖ <span id="weekTitle">This Week</span></h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="changeWeek(-1)" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 16px;">‚Üê</button>
                        <span id="weekRange" style="font-size: 12px; color: var(--text-secondary); min-width: 120px; text-align: center;"></span>
                        <button onclick="changeWeek(1)" id="weekNextBtn" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 16px;">‚Üí</button>
                    </div>
                </div>
                <div id="weeklyOverview">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Monthly Tabs -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÜ Monthly Overview</h2>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="btn-month active" onclick="switchMonth(0)">This Month</button>
                    <button class="btn-month" onclick="switchMonth(-1)">Last Month</button>
                    <button class="btn-month" onclick="switchMonth(-2)">2 Months Ago</button>
                </div>
                <div id="monthTitle" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;"></div>
                <div id="monthlyOverview">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- TRACKER VIEW (Combined Log + History) -->
        <div id="trackerView" class="view">
            <!-- Date Selector -->
            <div class="date-selector">
                <div class="date-selector-label">Tracking for</div>
                <div class="date-selector-value" id="reviewDateDisplay">Today</div>
                <input
                    type="date"
                    id="selectedDate"
                    onchange="loadSelectedDate()">
            </div>

            <!-- Modern Habit Cards -->
            <div id="modernHabits">
                <!-- Populated by JS -->
            </div>

            <!-- Mood & Notes Card -->
            <div class="card" style="margin-top: 20px;">
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px;">
                        <label style="font-weight: 600; font-size: 16px; margin-bottom: 8px; display: block;">üòä How was your day? (1-10)</label>
                        <input type="number" min="1" max="10" id="mood" placeholder="7" style="width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; font-size: 16px; margin-bottom: 8px; display: block;">üìù Notes</label>
                        <textarea id="notes" rows="3" placeholder="Any thoughts about today?" style="width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveEntry()" style="margin-top: 20px;">üíæ Save Entry</button>

            <!-- Complete History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìä Your Complete History</h2>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    All your daily habit tracking data - click Edit to modify any day
                </div>
                <div id="detailedHistory" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Weekly Targets</h2>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    Set how many times per week you want to do each habit
                </div>
                <div class="habit-list" id="settingsHabits">
                    <!-- Populated by JS -->
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>

        </div>
    </div>

    <!-- AI Chat Button -->
    <button class="ai-chat-button" onclick="toggleAIChat()" id="aiChatButton" style="display: none;">
        ü§ñ
    </button>

    <!-- AI Chat Modal -->
    <div class="ai-chat-modal" id="aiChatModal">
        <div class="ai-chat-container">
            <div class="ai-chat-header">
                <div class="ai-chat-title">
                    ü§ñ AI Coach - Gemini
                </div>
                <button class="ai-chat-close" onclick="toggleAIChat()">√ó</button>
            </div>
            <div class="ai-chat-messages" id="aiChatMessages">
                <!-- Messages will be added here -->
            </div>
            <div class="ai-chat-input-container">
                <textarea
                    class="ai-chat-input"
                    id="aiChatInput"
                    placeholder="Ask about your progress, get advice..."
                    rows="1"
                    onkeypress="handleAIChatKeyPress(event)"></textarea>
                <button class="ai-chat-send" onclick="sendAIMessage()" id="aiChatSend">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCbdjv2kmYl9em_E1Xd3G_m3TPJ-308o68",
            authDomain: "better-me-8e533.firebaseapp.com",
            projectId: "better-me-8e533",
            storageBucket: "better-me-8e533.firebasestorage.app",
            messagingSenderId: "200319965841",
            appId: "1:200319965841:web:37bbc5588fdd8e8b16bd30",
            databaseURL: "https://better-me-8e533-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Set persistence to LOCAL (stays logged in even after closing browser)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // Global variables
        let currentUser = null;
        let isSignUpMode = true;

        // Data structure with default targets and start dates
        let habits = [
            { id: 'running', name: 'Running', emoji: 'üèÉ', hasMetric: true, metricLabel: 'km', target: 4, startDate: null },
            { id: 'icebaths', name: 'Ice Baths', emoji: 'üßä', hasMetric: false, target: 7, startDate: null },
            { id: 'meditation', name: 'Meditation', emoji: 'üßò', hasMetric: true, metricLabel: 'min', target: 7, startDate: null },
            { id: 'diary', name: 'Diary', emoji: 'üìî', hasMetric: false, target: 7, startDate: null },
            { id: 'english', name: 'English', emoji: 'üó£Ô∏è', hasMetric: false, target: 3, startDate: null },
            { id: 'fitness', name: 'Fitness', emoji: 'üí™', hasMetric: true, metricLabel: 'min', target: 3, startDate: null }
        ];

        let data = {};
        let settings = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';

                    // Load user data
                    await loadDataFromFirebase();
                    await loadSettingsFromFirebase();
                    loadSettingsIntoHabits();
                    updateCurrentDate();
                    loadOverviewView();
                    updateStats();
                    updateMotivation();
                    renderWeekCalendar();
                } else {
                    // User is signed out
                    currentUser = null;
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });
        });

        // Auth Functions
        async function handleAuth(event) {
            event.preventDefault();

            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');

            errorEl.classList.add('hidden');

            try {
                if (isSignUpMode) {
                    // Sign up new user
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    // Sign in existing user
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.remove('hidden');
            }
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;

            const subtitle = document.getElementById('authSubtitle');
            const button = document.getElementById('authButton');
            const toggleText = document.getElementById('authToggleText');
            const toggleButton = document.querySelector('.auth-toggle button');

            if (isSignUpMode) {
                subtitle.textContent = 'Sign up to start tracking your habits';
                button.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleButton.textContent = 'Sign In';
            } else {
                subtitle.textContent = 'Welcome back! Sign in to continue';
                button.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleButton.textContent = 'Sign Up';
            }

            // Clear error
            document.getElementById('authError').classList.add('hidden');
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/email-already-in-use':
                    return 'This email is already registered. Please sign in instead.';
                case 'auth/invalid-email':
                    return 'Invalid email address.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }

        // Firebase Data Functions
        async function loadDataFromFirebase() {
            if (!currentUser) return;
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}/habitData`).once('value');
                data = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading data:', error);
                data = {};
            }
        }

        async function saveData() {
            if (!currentUser) return;
            try {
                await database.ref(`users/${currentUser.uid}/habitData`).set(data);
            } catch (error) {
                console.error('Error saving data:', error);
                alert('‚ö†Ô∏è Error saving data. Please try again.');
            }
        }

        async function loadSettingsFromFirebase() {
            if (!currentUser) return;
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}/settings`).once('value');
                settings = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading settings:', error);
                settings = {};
            }
        }

        async function saveSettingsData() {
            if (!currentUser) return;
            try {
                await database.ref(`users/${currentUser.uid}/settings`).set(settings);
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('‚ö†Ô∏è Error saving settings. Please try again.');
            }
        }

        function loadSettingsIntoHabits() {
            // Update habit targets and start dates from saved settings
            habits.forEach(habit => {
                if (settings[habit.id] !== undefined) {
                    habit.target = settings[habit.id];
                }
                if (settings[habit.id + '_startDate'] !== undefined) {
                    habit.startDate = settings[habit.id + '_startDate'];
                }
            });
        }

        function updateCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
        }

        function getTodayKey() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function switchView(view) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');

            // Refresh data
            if (view === 'overview') loadOverviewView();
            if (view === 'tracker') {
                selectedDateKey = null; // Reset to today when switching to tracker view
                loadTrackerView();
            }
            if (view === 'settings') loadSettingsView();
        }

        function loadOverviewView() {
            updateStats();
            updateMotivation();
            renderWeeklyOverview(selectedWeekOffset);
            renderMonthlyOverview(selectedMonthOffset);
        }

        function changeWeek(direction) {
            selectedWeekOffset += direction;
            renderWeeklyOverview(selectedWeekOffset);

            // Update next button state (disable if viewing current week)
            const nextBtn = document.getElementById('weekNextBtn');
            if (selectedWeekOffset >= 0) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.3';
                nextBtn.style.cursor = 'not-allowed';
                selectedWeekOffset = 0; // Can't go beyond current week
            } else {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }

        let selectedDateKey = null;
        let selectedMonthOffset = 0; // 0 = this month, -1 = last month, etc.
        let selectedWeekOffset = 0; // 0 = this week, -1 = last week, etc.

        function loadTrackerView() {
            renderModernHabits();
            loadLogView();
            renderDetailedHistory();
        }

        function renderModernHabits() {
            const container = document.getElementById('modernHabits');
            container.innerHTML = '';

            const dateKey = selectedDateKey || getTodayKey();
            const dateData = data[dateKey] || {};

            habits.forEach(habit => {
                const habitData = dateData[habit.id] || {};
                const isDone = habitData.done || false;
                const value = habitData.value || '';

                const card = document.createElement('div');
                card.className = 'habit-card' + (isDone ? ' active' : '');
                card.id = 'modern-habit-' + habit.id;

                const metricInput = habit.hasMetric ? `
                    <div class="metric-input-container ${isDone ? 'show' : ''}" id="metric-${habit.id}">
                        <div class="metric-input-wrapper">
                            <span class="metric-label">${habit.metricLabel === 'km' ? 'Distance' : 'Duration'}</span>
                            <input
                                type="number"
                                step="${habit.metricLabel === 'km' ? '0.1' : '1'}"
                                id="${habit.id}-${habit.metricLabel}"
                                placeholder="0${habit.metricLabel === 'km' ? '.0' : ''}"
                                value="${value}"
                                onclick="event.stopPropagation()">
                            <span class="metric-label">${habit.metricLabel}</span>
                        </div>
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="habit-toggle-header" onclick="toggleModernHabit('${habit.id}')">
                        <div class="habit-icon">${habit.emoji}</div>
                        <div class="habit-info">
                            <div class="habit-title">${habit.name}</div>
                            <div class="habit-subtitle">${isDone ? (value ? `${value} ${habit.metricLabel}` : 'Completed ‚úì') : 'Tap to mark as done'}</div>
                        </div>
                        <div class="toggle-switch ${isDone ? 'active' : ''}" id="toggle-${habit.id}">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    ${metricInput}
                `;

                container.appendChild(card);
            });
        }

        function toggleModernHabit(habitId) {
            const card = document.getElementById('modern-habit-' + habitId);
            const toggle = document.getElementById('toggle-' + habitId);
            const metricContainer = document.getElementById('metric-' + habitId);

            const isActive = toggle.classList.contains('active');

            if (isActive) {
                card.classList.remove('active');
                toggle.classList.remove('active');
                if (metricContainer) {
                    metricContainer.classList.remove('show');
                }
            } else {
                card.classList.add('active');
                toggle.classList.add('active');
                if (metricContainer) {
                    metricContainer.classList.add('show');
                    // Focus on input
                    const input = metricContainer.querySelector('input');
                    if (input) {
                        setTimeout(() => input.focus(), 300);
                    }
                }
            }

            updateSubtitle(habitId);
        }

        function updateSubtitle(habitId) {
            const habit = habits.find(h => h.id === habitId);
            const card = document.getElementById('modern-habit-' + habitId);
            const toggle = document.getElementById('toggle-' + habitId);
            const isActive = toggle.classList.contains('active');

            const subtitle = card.querySelector('.habit-subtitle');

            if (isActive) {
                if (habit.hasMetric) {
                    const input = document.getElementById(habit.id + '-' + habit.metricLabel);
                    const value = input ? input.value : '';
                    subtitle.textContent = value ? `${value} ${habit.metricLabel}` : 'Completed ‚úì';

                    // Update subtitle when input changes
                    if (input) {
                        input.oninput = () => {
                            subtitle.textContent = input.value ? `${input.value} ${habit.metricLabel}` : 'Completed ‚úì';
                        };
                    }
                } else {
                    subtitle.textContent = 'Completed ‚úì';
                }
            } else {
                subtitle.textContent = 'Tap to mark as done';
            }
        }

        function loadLogView() {
            const dateKey = selectedDateKey || getTodayKey();
            const dateData = data[dateKey] || {};

            // Update date picker
            document.getElementById('selectedDate').value = dateKey;

            // Update review date display
            const date = new Date(dateKey);
            const isToday = dateKey === getTodayKey();
            const displayDate = isToday ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('reviewDateDisplay').textContent = displayDate;

            // Render modern habits
            renderModernHabits();

            // Load mood and notes
            document.getElementById('mood').value = dateData.mood || '';
            document.getElementById('notes').value = dateData.notes || '';
        }

        function loadSelectedDate() {
            selectedDateKey = document.getElementById('selectedDate').value;
            loadLogView();
        }

        async function saveEntry() {
            const dateKey = selectedDateKey || getTodayKey();

            if (!data[dateKey]) {
                data[dateKey] = {};
            }

            // Save habits from modern cards
            habits.forEach(habit => {
                const toggle = document.getElementById('toggle-' + habit.id);
                const done = toggle ? toggle.classList.contains('active') : false;

                data[dateKey][habit.id] = { done };

                // Save metrics
                if (habit.hasMetric) {
                    const input = document.getElementById(habit.id + '-' + habit.metricLabel);
                    if (input && input.value) {
                        data[dateKey][habit.id].value = parseFloat(input.value);
                    }
                }
            });

            // Save mood and notes
            const mood = document.getElementById('mood').value;
            const notes = document.getElementById('notes').value;

            if (mood) data[dateKey].mood = parseInt(mood);
            if (notes) data[dateKey].notes = notes;

            await saveData();

            // Show success feedback
            const isToday = dateKey === getTodayKey();
            alert(isToday ? '‚úÖ Entry saved to cloud successfully!' : '‚úÖ Past entry updated successfully!');

            // Refresh views
            loadOverviewView();
            updateStats();
            updateMotivation();
            renderWeekCalendar();
            renderDetailedHistory();
        }

        function updateStats() {
            const todayKey = getTodayKey();
            const todayData = data[todayKey] || {};

            // Today's completion (only count habits that have started)
            let todayCompleted = 0;
            let todayActiveHabits = 0;
            habits.forEach(habit => {
                if (!habit.startDate || todayKey >= habit.startDate) {
                    todayActiveHabits++;
                    if (todayData[habit.id]?.done) todayCompleted++;
                }
            });
            const todayPercent = todayActiveHabits > 0 ? Math.round((todayCompleted / todayActiveHabits) * 100) : 0;
            document.getElementById('todayCompletion').textContent = todayPercent + '%';

            // Week completion (Monday-Sunday, respecting start dates)
            const weekData = getCurrentWeekData();
            let weekExpected = 0;
            let weekCompleted = 0;

            habits.forEach(habit => {
                let habitWeekExpected = 0;
                weekData.forEach(day => {
                    if (!habit.startDate || day.date >= habit.startDate) {
                        habitWeekExpected++;
                        if (day.data[habit.id]?.done) weekCompleted++;
                    }
                });
                // Scale target to actual active days in this week
                const daysActive = habitWeekExpected;
                weekExpected += Math.round((habit.target / 7) * daysActive);
            });

            const weekPercent = weekExpected > 0 ? Math.round((weekCompleted / weekExpected) * 100) : 0;
            document.getElementById('weekCompletion').textContent = weekPercent + '%';

            // Streak
            const streak = calculateStreak();
            document.getElementById('weekStreak').textContent = streak;

            // Month completion (calendar month, respecting start dates)
            const monthInfo = getMonthData(0); // Current month
            const monthData = monthInfo.data;
            let monthExpected = 0;
            let monthCompleted = 0;

            habits.forEach(habit => {
                let habitMonthExpected = 0;
                monthData.forEach(day => {
                    if (!habit.startDate || day.date >= habit.startDate) {
                        habitMonthExpected++;
                        if (day.data[habit.id]?.done) monthCompleted++;
                    }
                });
                // Scale target to actual active days in this month
                monthExpected += Math.round((habit.target / 7) * habitMonthExpected);
            });

            const monthPercent = monthExpected > 0 ? Math.round((monthCompleted / monthExpected) * 100) : 0;
            document.getElementById('monthCompletion').textContent = monthPercent + '%';
        }

        function getCurrentWeekData() {
            // Get current week Monday-Sunday
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days

            const result = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysFromMonday + i);
                const key = date.toISOString().split('T')[0];
                result.push({ date: key, data: data[key] || {} });
            }
            return result;
        }

        function getPreviousWeekData() {
            // Get last week Monday-Sunday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            const result = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysFromMonday - 7 + i); // Go back one week
                const key = date.toISOString().split('T')[0];
                result.push({ date: key, data: data[key] || {} });
            }
            return result;
        }

        function getMonthData(monthOffset = 0) {
            // Get calendar month data (monthOffset: 0 = current, -1 = last month, etc.)
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + monthOffset;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const result = [];
            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                const key = d.toISOString().split('T')[0];
                result.push({ date: key, data: data[key] || {} });
            }

            return {
                data: result,
                monthName: firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                daysInMonth: result.length
            };
        }

        function updateMotivation() {
            // Use last 30 days rolling (never resets)
            const last30Days = getLastNDays(30);

            // Helper function to count days a habit was active in the period
            function getActiveDays(habit) {
                if (!habit.startDate) return last30Days.length; // No start date = active for all days

                let activeDays = 0;
                last30Days.forEach(day => {
                    if (day.date >= habit.startDate) activeDays++;
                });
                return activeDays;
            }

            // Calculate habit completion for last 30 days (respecting start dates)
            let running = 0, icebaths = 0, meditation = 0, diary = 0, english = 0, fitness = 0;
            let totalCompleted = 0, totalExpected = 0;

            const runningHabit = habits.find(h => h.id === 'running');
            const icebathHabit = habits.find(h => h.id === 'icebaths');
            const meditationHabit = habits.find(h => h.id === 'meditation');
            const diaryHabit = habits.find(h => h.id === 'diary');
            const englishHabit = habits.find(h => h.id === 'english');
            const fitnessHabit = habits.find(h => h.id === 'fitness');

            last30Days.forEach(day => {
                if (day.date >= (runningHabit.startDate || '2000-01-01') && day.data.running?.done) running++;
                if (day.date >= (icebathHabit.startDate || '2000-01-01') && day.data.icebaths?.done) icebaths++;
                if (day.date >= (meditationHabit.startDate || '2000-01-01') && day.data.meditation?.done) meditation++;
                if (day.date >= (diaryHabit.startDate || '2000-01-01') && day.data.diary?.done) diary++;
                if (day.date >= (englishHabit.startDate || '2000-01-01') && day.data.english?.done) english++;
                if (day.date >= (fitnessHabit.startDate || '2000-01-01') && day.data.fitness?.done) fitness++;
            });

            // Expected based on active days only
            const runningActiveDays = getActiveDays(runningHabit);
            const icebathActiveDays = getActiveDays(icebathHabit);
            const meditationActiveDays = getActiveDays(meditationHabit);
            const diaryActiveDays = getActiveDays(diaryHabit);
            const englishActiveDays = getActiveDays(englishHabit);
            const fitnessActiveDays = getActiveDays(fitnessHabit);

            const runningExpected = Math.round((runningHabit.target / 7) * runningActiveDays);
            const icebathExpected = Math.round((icebathHabit.target / 7) * icebathActiveDays);
            const meditationExpected = Math.round((meditationHabit.target / 7) * meditationActiveDays);
            const diaryExpected = Math.round((diaryHabit.target / 7) * diaryActiveDays);
            const englishExpected = Math.round((englishHabit.target / 7) * englishActiveDays);
            const fitnessExpected = Math.round((fitnessHabit.target / 7) * fitnessActiveDays);

            totalExpected = runningExpected + icebathExpected + meditationExpected + diaryExpected + englishExpected + fitnessExpected;
            totalCompleted = running + icebaths + meditation + diary + english + fitness;

            // Overall Discipline Score (last 30 days, respecting start dates)
            const disciplineScore = totalExpected > 0 ? Math.round((totalCompleted / totalExpected) * 100) : 0;
            document.getElementById('disciplineScore').textContent = disciplineScore + '%';

            // Physical: Running + Fitness (respecting start dates)
            const physicalExpected = runningExpected + fitnessExpected;
            const physicalCompleted = running + fitness;
            const physicalScore = physicalExpected > 0 ? Math.round((physicalCompleted / physicalExpected) * 100) : 0;
            document.getElementById('physicalScore').textContent = physicalScore + '%';

            // Mental: Ice Baths + Meditation + Diary (respecting start dates)
            const mentalExpected = icebathExpected + meditationExpected + diaryExpected;
            const mentalCompleted = icebaths + meditation + diary;
            const mentalScore = mentalExpected > 0 ? Math.round((mentalCompleted / mentalExpected) * 100) : 0;
            document.getElementById('mentalScore').textContent = mentalScore + '%';

            // Skills: English (respecting start date)
            const skillsScore = englishExpected > 0 ? Math.round((english / englishExpected) * 100) : 0;
            document.getElementById('skillsScore').textContent = skillsScore + '%';

            // Self-Discipline Streak (counts weeks, not days)
            const streak = calculateStreak();
            document.getElementById('disciplineStreak').textContent = streak + ' week' + (streak !== 1 ? 's' : '');

            // Update streak description
            const totalWeeklyTarget = habits.reduce((sum, h) => sum + h.target, 0);
            document.getElementById('streakDescription').textContent = `Weeks with 80%+ completion (${Math.round(totalWeeklyTarget * 0.8)}/${totalWeeklyTarget} habits)`;

            // Dynamic Motivational Message
            const messages = {
                excellent: [
                    "You're not just doing habits. You're proving to yourself who you really are.",
                    "Discipline is building your future self. Every day, you're becoming stronger.",
                    "This consistency isn't luck - it's you choosing transformation every single day.",
                    "You're building an identity of someone who keeps their word to themselves."
                ],
                good: [
                    "You're showing up. That's what separates dreamers from achievers.",
                    "Each habit completed is a vote for the person you're becoming.",
                    "The discipline you're building now will compound into everything you do.",
                    "You're not perfect, but you're consistent. That's what matters most."
                ],
                moderate: [
                    "Transformation isn't linear. Every day you try is a day you're growing.",
                    "The gap between who you are and who you want to be closes with each habit.",
                    "You started this journey for a reason. That reason is still valid.",
                    "Self-discipline isn't built in perfect weeks - it's built by showing up after setbacks."
                ],
                low: [
                    "This week is just one chapter. Your transformation story is far from over.",
                    "The person you want to become is built in weeks like this - when you choose to continue.",
                    "You're learning what it takes. This data is valuable. Use it to adapt.",
                    "Discipline isn't about never falling - it's about always getting back up."
                ]
            };

            let messageCategory;
            if (disciplineScore >= 80) messageCategory = 'excellent';
            else if (disciplineScore >= 60) messageCategory = 'good';
            else if (disciplineScore >= 40) messageCategory = 'moderate';
            else messageCategory = 'low';

            const randomMessage = messages[messageCategory][Math.floor(Math.random() * messages[messageCategory].length)];
            document.getElementById('motivationMessage').textContent = randomMessage;

            // Calculate impact insights for the "Show My Impact" section
            calculateImpactInsights();
        }

        function toggleImpactInsights() {
            const insights = document.getElementById('impactInsights');
            const buttonText = document.getElementById('impactButtonText');

            if (insights.style.maxHeight === '0px' || !insights.style.maxHeight) {
                insights.style.maxHeight = '2000px';
                buttonText.textContent = '‚ú® Hide Insights';
            } else {
                insights.style.maxHeight = '0px';
                buttonText.textContent = '‚ú® Show My Impact';
            }
        }

        function calculateImpactInsights() {
            // Get all historical data
            const allDates = Object.keys(data).sort();
            if (allDates.length === 0) return;

            // Calculate totals
            let totalRunningKm = 0;
            let totalRunningDays = 0;
            let totalIceBaths = 0;
            let totalMeditationMin = 0;
            let totalMeditationDays = 0;
            let totalDiaryDays = 0;
            let totalEnglishDays = 0;
            let totalFitnessMin = 0;
            let totalFitnessDays = 0;

            allDates.forEach(date => {
                const dayData = data[date];
                if (dayData.running?.done) {
                    totalRunningDays++;
                    if (dayData.running.value) totalRunningKm += dayData.running.value;
                }
                if (dayData.icebaths?.done) totalIceBaths++;
                if (dayData.meditation?.done) {
                    totalMeditationDays++;
                    if (dayData.meditation.value) totalMeditationMin += dayData.meditation.value;
                }
                if (dayData.diary?.done) totalDiaryDays++;
                if (dayData.english?.done) totalEnglishDays++;
                if (dayData.fitness?.done) {
                    totalFitnessDays++;
                    if (dayData.fitness.value) totalFitnessMin += dayData.fitness.value;
                }
            });

            // Calculate averages and rates
            const daysSinceStart = allDates.length;
            const weeksSinceStart = daysSinceStart / 7;
            const avgRunningKm = totalRunningDays > 0 ? (totalRunningKm / totalRunningDays).toFixed(1) : 0;
            const avgMeditationMin = totalMeditationDays > 0 ? Math.round(totalMeditationMin / totalMeditationDays) : 0;
            const avgFitnessMin = totalFitnessDays > 0 ? Math.round(totalFitnessMin / totalFitnessDays) : 0;

            // Weekly averages
            const runningPerWeek = weeksSinceStart > 0 ? (totalRunningDays / weeksSinceStart).toFixed(1) : 0;
            const runningKmPerWeek = weeksSinceStart > 0 ? (totalRunningKm / weeksSinceStart).toFixed(1) : 0;
            const icebathsPerWeek = weeksSinceStart > 0 ? (totalIceBaths / weeksSinceStart).toFixed(1) : 0;
            const meditationPerWeek = weeksSinceStart > 0 ? (totalMeditationDays / weeksSinceStart).toFixed(1) : 0;
            const fitnessPerWeek = weeksSinceStart > 0 ? (totalFitnessDays / weeksSinceStart).toFixed(1) : 0;

            // Calories: Running burns ~60 cal per km on average
            const totalCaloriesBurned = Math.round(totalRunningKm * 60);
            const caloriesPerWeek = weeksSinceStart > 0 ? Math.round((totalRunningKm * 60) / weeksSinceStart) : 0;
            const caloriesPerDay = daysSinceStart > 0 ? Math.round((totalRunningKm * 60) / daysSinceStart) : 0;

            // Physical Impact
            const physicalImpactHTML = `
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üèÉ Running Statistics:</div>
                    ‚Ä¢ Total distance: <b>${totalRunningKm.toFixed(1)} km</b> (${(totalRunningKm * 0.621371).toFixed(1)} miles)<br>
                    ‚Ä¢ Total runs: <b>${totalRunningDays}</b> sessions<br>
                    ‚Ä¢ Average per run: <b>${avgRunningKm} km</b><br>
                    ‚Ä¢ Runs per week: <b>${runningPerWeek}</b> sessions<br>
                    ‚Ä¢ Distance per week: <b>${runningKmPerWeek} km</b><br>
                    ‚Ä¢ Consistency rate: <b>${Math.round((totalRunningDays / daysSinceStart) * 100)}%</b> of days
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üî• Calories & Energy:</div>
                    ‚Ä¢ Total burned: <b>${totalCaloriesBurned.toLocaleString()} calories</b><br>
                    ‚Ä¢ Average per week: <b>${caloriesPerWeek} cal/week</b><br>
                    ‚Ä¢ Average per day: <b>${caloriesPerDay} cal/day</b><br>
                    ‚Ä¢ Equivalent: <b>${(totalCaloriesBurned / 7700).toFixed(1)} kg</b> of fat potential loss
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üßä Ice Baths:</div>
                    ‚Ä¢ Total sessions: <b>${totalIceBaths}</b><br>
                    ‚Ä¢ Per week: <b>${icebathsPerWeek}</b> sessions<br>
                    ‚Ä¢ Consistency rate: <b>${Math.round((totalIceBaths / daysSinceStart) * 100)}%</b> of days<br>
                    ‚Ä¢ Dopamine increase: <b>+250%</b> baseline (scientific research, 1-3h)<br>
                    ‚Ä¢ Norepinephrine: <b>+530%</b> (stress adaptation)<br>
                    ‚Ä¢ Cold adaptation: <b>${Math.min(totalIceBaths * 2, 100)}%</b>
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üí™ Fitness Training:</div>
                    ‚Ä¢ Total sessions: <b>${totalFitnessDays}</b><br>
                    ‚Ä¢ Total time: <b>${totalFitnessMin} minutes</b> (<b>${(totalFitnessMin / 60).toFixed(1)}h</b>)<br>
                    ‚Ä¢ Average per session: <b>${avgFitnessMin} min</b><br>
                    ‚Ä¢ Per week: <b>${fitnessPerWeek}</b> sessions<br>
                    ‚Ä¢ Consistency rate: <b>${Math.round((totalFitnessDays / daysSinceStart) * 100)}%</b> of days
                </div>
                <div style="padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üìà Cardiovascular Improvements (Conservative):</div>
                    ‚Ä¢ Estimated VO2 max increase: <b>+${Math.min(totalRunningDays * 0.2, 8).toFixed(1)}%</b><br>
                    ‚Ä¢ Resting heart rate reduction: <b>-${Math.min(totalRunningDays * 0.15, 5).toFixed(0)} BPM</b><br>
                    ‚Ä¢ Aerobic capacity: <b>+${Math.min(totalRunningDays * 0.3, 10).toFixed(1)}%</b><br>
                    ‚Ä¢ Recovery time: <b>-${Math.min(totalRunningDays * 0.25, 12).toFixed(0)}%</b> faster
                </div>
            `;
            document.getElementById('physicalImpact').innerHTML = physicalImpactHTML;

            // Mental Impact
            const totalMeditationHours = (totalMeditationMin / 60).toFixed(1);
            const diaryPerWeek = weeksSinceStart > 0 ? (totalDiaryDays / weeksSinceStart).toFixed(1) : 0;
            const englishPerWeek = weeksSinceStart > 0 ? (totalEnglishDays / weeksSinceStart).toFixed(1) : 0;
            const meditationMinPerWeek = weeksSinceStart > 0 ? Math.round(totalMeditationMin / weeksSinceStart) : 0;

            const mentalImpactHTML = `
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üßò Meditation Practice:</div>
                    ‚Ä¢ Total time: <b>${totalMeditationMin} minutes</b> (<b>${totalMeditationHours} hours</b>)<br>
                    ‚Ä¢ Total sessions: <b>${totalMeditationDays}</b><br>
                    ‚Ä¢ Average per session: <b>${avgMeditationMin} min</b><br>
                    ‚Ä¢ Per week: <b>${meditationPerWeek}</b> sessions, <b>${meditationMinPerWeek} min</b><br>
                    ‚Ä¢ Consistency rate: <b>${Math.round((totalMeditationDays / daysSinceStart) * 100)}%</b> of days<br>
                    ‚Ä¢ Focus improvement: <b>+${Math.min(totalMeditationDays * 0.8, 25)}%</b> (realistic)
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üßä Cold Exposure Mental Benefits:</div>
                    ‚Ä¢ Total sessions: <b>${totalIceBaths}</b><br>
                    ‚Ä¢ Dopamine increase per session: <b>+250%</b> (2-3 hours duration)<br>
                    ‚Ä¢ Total dopamine boosts: <b>${totalIceBaths}</b> sessions<br>
                    ‚Ä¢ Stress resilience: <b>+${Math.min(totalIceBaths * 1.5, 40)}%</b> (conservative)<br>
                    ‚Ä¢ Mental toughness events: <b>${totalIceBaths}</b> (discipline building)
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üìî Journaling Impact:</div>
                    ‚Ä¢ Total entries: <b>${totalDiaryDays}</b><br>
                    ‚Ä¢ Per week: <b>${diaryPerWeek}</b> entries<br>
                    ‚Ä¢ Consistency rate: <b>${Math.round((totalDiaryDays / daysSinceStart) * 100)}%</b> of days<br>
                    ‚Ä¢ Self-awareness growth: <b>+${Math.min(totalDiaryDays * 1.2, 35)}%</b> (gradual)<br>
                    ‚Ä¢ Emotional processing sessions: <b>${totalDiaryDays}</b><br>
                    ‚Ä¢ Stress reduction: <b>-${Math.min(totalDiaryDays * 0.8, 25)}%</b> (realistic)
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üó£Ô∏è English Learning:</div>
                    ‚Ä¢ Total sessions: <b>${totalEnglishDays}</b><br>
                    ‚Ä¢ Per week: <b>${englishPerWeek}</b> sessions<br>
                    ‚Ä¢ Consistency rate: <b>${Math.round((totalEnglishDays / daysSinceStart) * 100)}%</b> of days<br>
                    ‚Ä¢ Practice sessions: <b>${totalEnglishDays}</b> (neural adaptation ongoing)<br>
                    ‚Ä¢ Estimated vocabulary: <b>+${totalEnglishDays * 3}-${totalEnglishDays * 5} words</b><br>
                    ‚Ä¢ Language confidence: <b>+${Math.min(totalEnglishDays * 1.5, 30)}%</b>
                </div>
                <div style="padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">üß† Overall Brain Health (Research-Based):</div>
                    ‚Ä¢ Prefrontal cortex: <b>+${Math.min(totalMeditationDays * 0.15, 4).toFixed(1)}%</b> (gradual thickening)<br>
                    ‚Ä¢ Gray matter: <b>+${Math.min((totalMeditationDays + totalEnglishDays) * 0.08, 3).toFixed(1)}%</b> (takes months)<br>
                    ‚Ä¢ Stress regulation: <b>+${Math.min((totalMeditationDays + totalIceBaths) * 0.8, 30)}%</b><br>
                    ‚Ä¢ Cognitive flexibility: <b>+${Math.min((totalMeditationDays + totalEnglishDays) * 0.9, 25)}%</b>
                </div>
            `;
            document.getElementById('mentalImpact').innerHTML = mentalImpactHTML;

            // Future Projections (6 months & 1 year)
            const last30Days = getLastNDays(30);
            const runningHabit = habits.find(h => h.id === 'running');
            const icebathHabit = habits.find(h => h.id === 'icebaths');
            const meditationHabit = habits.find(h => h.id === 'meditation');
            const fitnessHabit = habits.find(h => h.id === 'fitness');
            const diaryHabit = habits.find(h => h.id === 'diary');

            const runningRate = last30Days.filter(d => d.data.running?.done).length / 30;
            const icebathRate = last30Days.filter(d => d.data.icebaths?.done).length / 30;
            const meditationRate = last30Days.filter(d => d.data.meditation?.done).length / 30;
            const fitnessRate = last30Days.filter(d => d.data.fitness?.done).length / 30;
            const diaryRate = last30Days.filter(d => d.data.diary?.done).length / 30;

            // 6 month projections
            const futureRunningKm6m = Math.round(runningRate * avgRunningKm * 180);
            const futureIceBaths6m = Math.round(icebathRate * 180);
            const futureMeditationHours6m = Math.round(meditationRate * avgMeditationMin * 180 / 60);
            const futureFitnessHours6m = Math.round(fitnessRate * avgFitnessMin * 180 / 60);
            const futureCalories6m = Math.round(runningRate * avgRunningKm * 60 * 180);
            const futureDiary6m = Math.round(diaryRate * 180);

            // 1 year projections
            const futureRunningKm1y = Math.round(runningRate * avgRunningKm * 365);
            const futureIceBaths1y = Math.round(icebathRate * 365);
            const futureMeditationHours1y = Math.round(meditationRate * avgMeditationMin * 365 / 60);
            const futureCalories1y = Math.round(runningRate * avgRunningKm * 60 * 365);

            const futureProjectionHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                    <div style="font-weight: 700; margin-bottom: 12px; font-size: 15px;">üìä 6 Month Projection (at current pace):</div>

                    <div style="margin-bottom: 8px;"><b>üèÉ Running:</b></div>
                    ‚Ä¢ Distance: <b>${futureRunningKm6m} km</b> (${(futureRunningKm6m * 0.621371).toFixed(0)} miles)<br>
                    ‚Ä¢ Marathons equivalent: <b>${(futureRunningKm6m / 42.2).toFixed(1)}</b><br>
                    ‚Ä¢ Half-marathons: <b>${(futureRunningKm6m / 21.1).toFixed(1)}</b><br>
                    ‚Ä¢ Calories burned: <b>${futureCalories6m.toLocaleString()}</b> (<b>${(futureCalories6m / 7700).toFixed(1)} kg</b> fat loss potential)<br>
                    ‚Ä¢ Expected VO2 max gain: <b>+${Math.min(runningRate * 180 * 0.2, 10).toFixed(1)}%</b> (realistic)<br>

                    <div style="margin-top: 8px; margin-bottom: 8px;"><b>üßä Ice Baths:</b></div>
                    ‚Ä¢ Total sessions: <b>${futureIceBaths6m}</b><br>
                    ‚Ä¢ Stress adaptation: <b>Significantly improved</b><br>
                    ‚Ä¢ HRV improvement: <b>+${Math.min(futureIceBaths6m * 0.3, 15).toFixed(0)}%</b> (conservative)<br>
                    ‚Ä¢ Mental resilience: <b>+${Math.min(futureIceBaths6m * 0.5, 35)}%</b><br>

                    <div style="margin-top: 8px; margin-bottom: 8px;"><b>üßò Meditation:</b></div>
                    ‚Ä¢ Total time: <b>${futureMeditationHours6m} hours</b> (${futureMeditationHours6m * 60} minutes)<br>
                    ‚Ä¢ Brain changes: <b>Measurable after 8+ weeks consistent practice</b><br>
                    ‚Ä¢ Gray matter: <b>+${Math.min(futureMeditationHours6m * 0.2, 4).toFixed(1)}%</b> (research-based)<br>
                    ‚Ä¢ Attention span: <b>+${Math.min(futureMeditationHours6m * 1, 30)}%</b><br>

                    <div style="margin-top: 8px; margin-bottom: 8px;"><b>üí™ Fitness:</b></div>
                    ‚Ä¢ Total time: <b>${futureFitnessHours6m} hours</b><br>
                    ‚Ä¢ Strength gains: <b>+${Math.min(fitnessRate * 180 * 0.8, 25)}%</b> (depends on intensity)<br>
                    ‚Ä¢ Muscle adaptation: <b>+${Math.min(fitnessRate * 180 * 0.15, 4).toFixed(1)}%</b> mass<br>

                    <div style="margin-top: 8px; margin-bottom: 8px;"><b>üìî Journaling:</b></div>
                    ‚Ä¢ Total entries: <b>${futureDiary6m}</b><br>
                    ‚Ä¢ Self-knowledge: <b>Significantly improved</b><br>
                    ‚Ä¢ Emotional clarity: <b>+${Math.min(futureDiary6m * 1, 40)}%</b>
                </div>

                <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid var(--danger);">
                    <div style="font-weight: 700; margin-bottom: 12px; font-size: 15px;">üöÄ 1 Year Projection (365 days):</div>

                    ‚Ä¢ Running: <b>${futureRunningKm1y} km</b> = <b>${(futureRunningKm1y / 42.2).toFixed(1)} marathons</b><br>
                    ‚Ä¢ Calories: <b>${futureCalories1y.toLocaleString()}</b> = <b>${(futureCalories1y / 7700).toFixed(1)} kg</b> potential fat loss<br>
                    ‚Ä¢ Ice baths: <b>${futureIceBaths1y}</b> sessions (elite consistency)<br>
                    ‚Ä¢ Meditation: <b>${futureMeditationHours1y} hours</b> (brain changes visible)<br>
                    ‚Ä¢ VO2 max: <b>+10-15%</b> (realistic for consistent training)<br>
                    ‚Ä¢ Biological markers: <b>Measurably improved</b><br>
                    ‚Ä¢ Fitness level: <b>Top 10%</b> of people your age (realistic)<br>
                    ‚Ä¢ Discipline: <b>Top 5%</b> globally (consistent habit tracking)
                </div>
            `;
            document.getElementById('futureProjection').innerHTML = futureProjectionHTML;

            // Total Stats Summary
            const totalStatsHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center; margin-bottom: 16px;">
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${daysSinceStart}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Days Tracked</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--success);">${totalRunningKm.toFixed(0)} km</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Total Distance</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--warning);">${totalCaloriesBurned.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Calories Burned</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${totalIceBaths}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Ice Bath Sessions</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--success);">${totalMeditationHours}h</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Meditation Time</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--warning);">${(totalFitnessMin / 60).toFixed(1)}h</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Fitness Time</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${totalDiaryDays}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Journal Entries</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--success);">${totalEnglishDays}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">English Sessions</div>
                    </div>
                    <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--warning);">${weeksSinceStart.toFixed(1)}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Weeks of Data</div>
                    </div>
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 12px; font-size: 12px; line-height: 1.8;">
                    <b>Weekly Averages:</b><br>
                    üèÉ Running: ${runningPerWeek} sessions, ${runningKmPerWeek} km, ${caloriesPerWeek} cal<br>
                    üßä Ice Baths: ${icebathsPerWeek} sessions<br>
                    üßò Meditation: ${meditationPerWeek} sessions, ${meditationMinPerWeek} min<br>
                    üí™ Fitness: ${fitnessPerWeek} sessions<br>
                    üìî Diary: ${diaryPerWeek} entries<br>
                    üó£Ô∏è English: ${englishPerWeek} sessions
                </div>
            `;
            document.getElementById('totalStats').innerHTML = totalStatsHTML;
        }

        function getWeekData(weeksAgo) {
            // Get data for a specific week (0 = current week, -1 = last week)
            const result = [];
            const startOffset = weeksAgo * 7;
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - startOffset - i);
                const key = date.toISOString().split('T')[0];
                result.push({
                    date: key,
                    data: data[key] || {}
                });
            }
            return result.reverse();
        }

        function calculateWeekCompletion(weekData) {
            let totalExpected = 0;
            let totalCompleted = 0;

            habits.forEach(habit => {
                totalExpected += habit.target;
                weekData.forEach(day => {
                    if (day.data[habit.id]?.done) totalCompleted++;
                });
            });

            return totalExpected > 0 ? Math.round((totalCompleted / totalExpected) * 100) : 0;
        }

        function getLastNDays(n) {
            const result = [];
            for (let i = 0; i < n; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                result.push({
                    date: key,
                    data: data[key] || {}
                });
            }
            return result.reverse();
        }

        function calculateStreak() {
            let streak = 0;

            const today = new Date();
            const dayOfWeek = today.getDay();

            // Start from last week if current week is incomplete (not Sunday)
            // Only count complete weeks for the streak
            const startWeek = (dayOfWeek === 0) ? 0 : 1; // If Sunday, include current week; otherwise start from last week

            // Check weeks going backward from most recent complete week
            for (let weeksAgo = startWeek; weeksAgo < 52; weeksAgo++) {
                const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

                // Get the Monday of the week we're checking
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - daysFromMonday - (weeksAgo * 7));

                // Calculate expected target for THIS WEEK based on active habits
                let weekExpected = 0;
                let weekCompleted = 0;

                habits.forEach(habit => {
                    let habitWeekExpected = 0;

                    // Count days this week where the habit was active
                    for (let i = 0; i < 7; i++) {
                        const checkDate = new Date(weekStart);
                        checkDate.setDate(weekStart.getDate() + i);
                        const key = checkDate.toISOString().split('T')[0];
                        const dayData = data[key];

                        // Only count if habit had started by this day
                        if (!habit.startDate || key >= habit.startDate) {
                            habitWeekExpected++;
                            if (dayData && dayData[habit.id]?.done) {
                                weekCompleted++;
                            }
                        }
                    }

                    // Add this habit's expected completions for the week
                    // Scale target to actual active days
                    weekExpected += Math.round((habit.target / 7) * habitWeekExpected);
                });

                // Week counts if you hit 80%+ of your weekly targets (respecting start dates)
                const weekPercentage = weekExpected > 0 ? (weekCompleted / weekExpected) : 0;
                if (weekPercentage >= 0.8) {
                    streak++;
                } else {
                    break; // Streak ends
                }
            }

            return streak;
        }

        function renderWeekCalendar() {
            const container = document.getElementById('weekCalendar');
            container.innerHTML = '';

            const weekData = getLastNDays(7);
            const todayKey = getTodayKey();

            weekData.forEach(day => {
                let completed = 0;
                habits.forEach(habit => {
                    if (day.data[habit.id]?.done) completed++;
                });

                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();

                const isToday = day.date === todayKey;
                const completionPercent = Math.round((completed / habits.length) * 100);

                const dayCard = document.createElement('div');
                dayCard.className = 'day-card' + (isToday ? ' today' : '') + (completionPercent === 100 ? ' completed' : '');
                dayCard.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-date">${dayNum}</div>
                    <div class="day-completion">${completionPercent}%</div>
                `;
                dayCard.onclick = () => {
                    selectedDateKey = day.date;
                    loadLogView();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                container.appendChild(dayCard);
            });
        }

        function renderWeeklyOverview(weekOffset = 0) {
            const container = document.getElementById('weeklyOverview');
            container.innerHTML = '';

            // Get week data based on offset
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            const weekData = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysFromMonday + i + (weekOffset * 7));
                const key = date.toISOString().split('T')[0];
                weekData.push({ date: key, data: data[key] || {} });
            }

            // Update week title
            const weekTitle = weekOffset === 0 ? 'This Week' :
                             weekOffset === -1 ? 'Last Week' :
                             `${Math.abs(weekOffset)} Weeks Ago`;
            document.getElementById('weekTitle').textContent = weekTitle;

            // Update week range display
            const firstDay = new Date(weekData[0].date);
            const lastDay = new Date(weekData[6].date);
            const rangeText = `${firstDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${lastDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            document.getElementById('weekRange').textContent = rangeText;

            habits.forEach(habit => {
                let completed = 0;

                weekData.forEach(day => {
                    if (day.data[habit.id]?.done) completed++;
                });

                const target = habit.target;
                const percent = Math.min(Math.round((completed / target) * 100), 100);
                const displayCompleted = Math.min(completed, target);

                const habitEl = document.createElement('div');
                habitEl.style.marginBottom = '16px';
                habitEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${habit.emoji} ${habit.name}</span>
                        <span style="font-weight: 700;">${displayCompleted}/${target} (${percent}%)${completed > target ? ' üî•' : ''}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(habitEl);
            });
        }

        function switchMonth(offset) {
            selectedMonthOffset = offset;

            // Update button active states
            const buttons = document.querySelectorAll('.btn-month');
            buttons.forEach((btn, idx) => {
                if (idx === Math.abs(offset)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render monthly overview
            renderMonthlyOverview(offset);
        }

        function renderMonthlyOverview(monthOffset = 0) {
            const container = document.getElementById('monthlyOverview');
            container.innerHTML = '';

            const monthInfo = getMonthData(monthOffset);
            const monthData = monthInfo.data;

            // Update month title
            document.getElementById('monthTitle').textContent = `${monthInfo.monthName} (${monthInfo.daysInMonth} days)`;

            habits.forEach(habit => {
                let completed = 0;
                let totalMetric = 0;

                monthData.forEach(day => {
                    if (day.data[habit.id]?.done) {
                        completed++;
                        if (habit.hasMetric && day.data[habit.id]?.value) {
                            totalMetric += day.data[habit.id].value;
                        }
                    }
                });

                // Calculate monthly target: weekly target * number of full weeks in this month
                const weeksInMonth = Math.floor(monthInfo.daysInMonth / 7);
                const monthlyTarget = habit.target * weeksInMonth;
                const percent = monthlyTarget > 0 ? Math.min(Math.round((completed / monthlyTarget) * 100), 100) : 0;
                const displayCompleted = Math.min(completed, monthlyTarget);

                const habitEl = document.createElement('div');
                habitEl.style.marginBottom = '16px';
                habitEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${habit.emoji} ${habit.name}</span>
                        <span style="font-weight: 700;">${displayCompleted}/${monthlyTarget} (${percent}%)${completed > monthlyTarget ? ' üî•' : ''}</span>
                    </div>
                    ${habit.hasMetric && totalMetric > 0 ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Total: ${totalMetric.toFixed(1)} ${habit.metricLabel}</div>` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(habitEl);
            });
        }

        function renderDetailedHistory() {
            const container = document.getElementById('detailedHistory');
            container.innerHTML = '';

            // Get all dates that have data, sorted newest first
            const allDates = Object.keys(data).sort().reverse();

            if (allDates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No data yet. Start tracking your habits!</div>';
                return;
            }

            // Create a table-like view
            allDates.forEach(date => {
                const dayData = data[date];
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

                let completedCount = 0;
                habits.forEach(habit => {
                    if (dayData[habit.id]?.done) completedCount++;
                });

                const dayCard = document.createElement('div');
                dayCard.style.background = 'var(--bg)';
                dayCard.style.padding = '16px';
                dayCard.style.borderRadius = '12px';
                dayCard.style.marginBottom = '12px';
                dayCard.style.border = '1px solid var(--border)';

                let habitsHTML = '';
                habits.forEach(habit => {
                    const habitData = dayData[habit.id];
                    const isDone = habitData?.done || false;
                    const value = habitData?.value;

                    const icon = isDone ? '‚úÖ' : '‚ùå';
                    const valueText = value ? ` (${value} ${habit.metricLabel})` : '';

                    habitsHTML += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                            <span style="font-size: 16px;">${icon}</span>
                            <span style="flex: 1; ${isDone ? 'color: var(--text);' : 'color: var(--text-secondary); opacity: 0.6;'}">${habit.emoji} ${habit.name}${valueText}</span>
                        </div>
                    `;
                });

                dayCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 700; font-size: 16px;">${formattedDate}</div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 14px; color: var(--text-secondary);">${completedCount}/${habits.length} completed</div>
                            <button onclick="editDay('${date}')" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Edit</button>
                        </div>
                    </div>
                    ${habitsHTML}
                    ${dayData.mood ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 14px; color: var(--text-secondary);">Mood: ${dayData.mood}/10</div>` : ''}
                    ${dayData.notes ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 14px; color: var(--text-secondary); font-style: italic;">"${dayData.notes}"</div>` : ''}
                `;

                container.appendChild(dayCard);
            });
        }

        function editDay(date) {
            // Scroll to top of tracker view
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Load the selected date in the form
            selectedDateKey = date;
            loadLogView();
        }

        function loadSettingsView() {
            const container = document.getElementById('settingsHabits');
            container.innerHTML = '';

            habits.forEach(habit => {
                const habitEl = document.createElement('div');
                habitEl.className = 'habit-item';
                habitEl.innerHTML = `
                    <div class="habit-header">
                        <span class="habit-name">${habit.emoji} ${habit.name}</span>
                    </div>
                    <div class="habit-metric">
                        <label>Times per week</label>
                        <input type="number" min="1" max="7" id="target-${habit.id}" value="${habit.target}">
                    </div>
                    <div class="habit-metric" style="margin-top: 12px;">
                        <label>Start date</label>
                        <input type="date" id="startDate-${habit.id}" value="${habit.startDate || ''}" style="flex: 1;">
                    </div>
                `;
                container.appendChild(habitEl);
            });
        }

        async function saveSettings() {
            habits.forEach(habit => {
                const targetInput = document.getElementById('target-' + habit.id);
                if (targetInput && targetInput.value) {
                    const newTarget = parseInt(targetInput.value);
                    if (newTarget >= 1 && newTarget <= 7) {
                        habit.target = newTarget;
                        settings[habit.id] = newTarget;
                    }
                }

                const startDateInput = document.getElementById('startDate-' + habit.id);
                if (startDateInput && startDateInput.value) {
                    habit.startDate = startDateInput.value;
                    settings[habit.id + '_startDate'] = startDateInput.value;
                }
            });

            await saveSettingsData();
            alert('‚úÖ Settings saved to cloud successfully!');

            // Refresh all views with new targets and start dates
            updateStats();
            updateMotivation();
            renderWeeklyOverview();
            renderMonthlyOverview();
        }

        // AI Chat Functions
        let aiChatHistory = [];
        // Using Google AI (Gemini)
        const GOOGLE_AI_API_KEY = 'AIzaSyCK2I1iUgmkwKAns3u9QK6EkzX9ECn2iis';

        function toggleAIChat() {
            const modal = document.getElementById('aiChatModal');
            const isOpen = modal.classList.contains('show');

            if (isOpen) {
                modal.classList.remove('show');
                // Re-enable body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            } else {
                modal.classList.add('show');
                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';

                // Auto-analyze habits on first open
                if (aiChatHistory.length === 0) {
                    // Add initial message to history
                    addAIMessage('assistant', 'ü§ñ Analyzing your habit data...');

                    // Auto-send analysis prompt
                    setTimeout(() => {
                        const input = document.getElementById('aiChatInput');
                        input.value = 'Show my improvements in 1, 3, 6, 12 months with specific numbers and percentages. Keep it short.';
                        sendAIMessage();
                    }, 500);
                } else {
                    // Scroll messages to bottom
                    setTimeout(() => {
                        const messagesContainer = document.getElementById('aiChatMessages');
                        if (messagesContainer) {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    }, 100);
                }
            }
        }

        function addAIMessage(role, content) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'ai-message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Add to history
            aiChatHistory.push({ role, content });
        }

        function showAITyping() {
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message assistant';
            typingDiv.id = 'aiTyping';

            const avatar = document.createElement('div');
            avatar.className = 'ai-message-avatar';
            avatar.textContent = 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-message-content';
            contentDiv.innerHTML = '<div class="ai-typing"><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div></div>';

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(contentDiv);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeAITyping() {
            const typing = document.getElementById('aiTyping');
            if (typing) typing.remove();
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const sendButton = document.getElementById('aiChatSend');
            const message = input.value.trim();

            if (!message) return;

            // Check if API key is set
            if (!GOOGLE_AI_API_KEY) {
                alert('‚ö†Ô∏è Google AI API key is missing.');
                return;
            }

            // Add user message
            addAIMessage('user', message);
            input.value = '';
            sendButton.disabled = true;

            // Show typing indicator
            showAITyping();

            try {
                // Prepare context with user's habit data
                const habitContext = prepareHabitContext();

                // Build conversation history for Gemini
                let conversationText = `You are an AI habit coach. Focus on NUMBERS and DATA.

${habitContext}

RESPONSE RULES:
1. Keep responses SHORT (max 200 words)
2. Use NUMBERS heavily (%, km, days, improvements)
3. Format with clear sections using emojis
4. Use bullet points
5. Be direct and specific
6. No long paragraphs

EXAMPLE FORMAT:
üìä **Current Stats**
‚Ä¢ Stat 1: X number
‚Ä¢ Stat 2: Y %

‚è±Ô∏è **1 Month**
‚Ä¢ Change 1: +X%
‚Ä¢ Change 2: Y km

Structure ALL responses this way.

`;

                // Add conversation history
                aiChatHistory.slice(1).forEach(msg => {
                    if (msg.role === 'user') {
                        conversationText += `\nUser: ${msg.content}\n`;
                    } else {
                        conversationText += `\nAssistant: ${msg.content}\n`;
                    }
                });

                conversationText += `\nUser: ${message}\nAssistant:`;

                // Call Google Gemini API - using gemini-2.5-flash
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GOOGLE_AI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: conversationText
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 8192,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API error:', errorData);
                    console.error('Full error details:', JSON.stringify(errorData, null, 2));
                    throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                const aiResponse = result.candidates[0].content.parts[0].text;

                // Remove typing and add AI response
                removeAITyping();
                addAIMessage('assistant', aiResponse);

            } catch (error) {
                console.error('AI Chat error:', error);
                removeAITyping();

                let errorMsg = '‚ùå Error Details:\n\n';
                if (error.message.includes('404')) {
                    errorMsg += '404: Model not found\n\n';
                    errorMsg += 'Tried: gemini-2.5-flash\n\n';
                    errorMsg += 'This model might not be available with your API key.';
                } else if (error.message.includes('403') || error.message.includes('401')) {
                    errorMsg += '403/401: Authentication failed\n\n';
                    errorMsg += 'Your API key might be invalid or expired.';
                } else if (error.message.includes('429')) {
                    errorMsg += '429: Rate limit exceeded\n\n';
                    errorMsg += 'Wait a moment and try again.';
                } else {
                    errorMsg += 'Full error:\n' + error.message.substring(0, 500);
                }

                addAIMessage('assistant', errorMsg);
            } finally {
                sendButton.disabled = false;
                // Reset textarea height
                const textarea = document.getElementById('aiChatInput');
                if (textarea) {
                    textarea.style.height = '44px';
                }
            }
        }

        function prepareHabitContext() {
            // Calculate summary statistics
            const allDates = Object.keys(data).sort();
            const daysSinceStart = allDates.length;

            let totalRunningKm = 0, totalRunningDays = 0;
            let totalIceBaths = 0;
            let totalMeditationMin = 0, totalMeditationDays = 0;
            let totalDiaryDays = 0, totalEnglishDays = 0;
            let totalFitnessMin = 0, totalFitnessDays = 0;

            allDates.forEach(date => {
                const dayData = data[date];
                if (dayData.running?.done) {
                    totalRunningDays++;
                    if (dayData.running.value) totalRunningKm += dayData.running.value;
                }
                if (dayData.icebaths?.done) totalIceBaths++;
                if (dayData.meditation?.done) {
                    totalMeditationDays++;
                    if (dayData.meditation.value) totalMeditationMin += dayData.meditation.value;
                }
                if (dayData.diary?.done) totalDiaryDays++;
                if (dayData.english?.done) totalEnglishDays++;
                if (dayData.fitness?.done) {
                    totalFitnessDays++;
                    if (dayData.fitness.value) totalFitnessMin += dayData.fitness.value;
                }
            });

            // Get last 7 days
            const last7Days = getLastNDays(7);
            let recentRunning = 0, recentIcebaths = 0, recentMeditation = 0;
            last7Days.forEach(day => {
                if (day.data.running?.done) recentRunning++;
                if (day.data.icebaths?.done) recentIcebaths++;
                if (day.data.meditation?.done) recentMeditation++;
            });

            const avgRunningKm = totalRunningDays > 0 ? (totalRunningKm / totalRunningDays).toFixed(1) : 0;
            const streak = calculateStreak();

            return `USER'S HABIT DATA:
- Tracking since: ${daysSinceStart} days
- Current streak: ${streak} weeks

RUNNING:
- Total: ${totalRunningKm.toFixed(1)} km over ${totalRunningDays} sessions
- Average: ${avgRunningKm} km per session
- Last 7 days: ${recentRunning} sessions

ICE BATHS:
- Total sessions: ${totalIceBaths}
- Last 7 days: ${recentIcebaths} sessions

MEDITATION:
- Total: ${totalMeditationMin} minutes over ${totalMeditationDays} sessions
- Average: ${totalMeditationDays > 0 ? Math.round(totalMeditationMin / totalMeditationDays) : 0} min/session
- Last 7 days: ${recentMeditation} sessions

OTHER HABITS:
- Fitness: ${totalFitnessDays} sessions, ${totalFitnessMin} minutes total
- Diary: ${totalDiaryDays} entries
- English: ${totalEnglishDays} sessions

Use this data to provide personalized insights and recommendations.`;
        }

        function handleAIChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAIMessage();
            }
        }

        // Auto-resize textarea as user types
        function autoResizeTextarea() {
            const textarea = document.getElementById('aiChatInput');
            if (textarea) {
                textarea.style.height = '44px';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
        }

        // Initialize textarea auto-resize
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('aiChatInput');
            if (textarea) {
                textarea.addEventListener('input', autoResizeTextarea);
            }
        });

        // Show AI chat button when user is logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('aiChatButton').style.display = 'flex';
            }
        });

    </script>
</body>
</html>
